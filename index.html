<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대건고 주식 모의투자 (V32 - Final Master)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .market-open { color: #16a34a; font-weight: 700; }
        .market-closed { color: #dc2626; font-weight: 700; }
        .price-up { color: #dc2626; } 
        .price-down { color: #2563eb; } 
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* 커스텀 스크롤바 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        .toast-exit { animation: fadeOut 0.3s ease-in forwards; }
        
        @keyframes newsFlash { 
            0% { background-color: #fff; } 
            50% { background-color: #fffbeb; } 
            100% { background-color: #fff; } 
        }
        .news-flash { animation: newsFlash 1s ease-in-out; }
        
        /* 기사 본문용 폰트 */
        .article-font { font-family: 'Noto Serif KR', serif; }
    </style>
</head>
<body class="text-gray-800">

    <div id="toast-container" class="fixed top-5 right-5 z-[100] flex flex-col space-y-3 w-80 pointer-events-none"></div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-100">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-indigo-700 mb-2">📈 대건고 주식 모의투자</h1>
                <p class="text-gray-500 text-sm">V32: 최종 완성본 (뉴스 데이터 확장)</p>
            </div>
            
            <form id="login-form" class="space-y-5" onsubmit="return false;">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                    <input type="text" id="login-name" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="이름 입력" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">학교 이메일 (ID)</label>
                    <input type="email" id="login-email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="예: id@pess.cnehs.kr" required>
                </div>
                <button id="login-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.02] active:scale-[0.98]">
                    로그인 및 접속
                </button>
            </form>
            
            <p id="login-msg" class="mt-4 text-center text-sm font-medium text-red-500 min-h-[20px]"></p>
            
            <div class="mt-6 pt-4 border-t border-gray-100 text-xs text-gray-400 text-center">
                <p>학교 도메인(@pess.cnehs.kr) 이메일로 로그인하세요.</p>
                <p id="db-status" class="mt-2 font-bold text-orange-500">데이터베이스 연결 시도 중...</p>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden min-h-screen flex flex-col">
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-gray-800 hidden sm:block">모의투자</h1>
                    <span id="market-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-500">장 준비 중</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p id="user-name-display" class="text-sm font-bold text-gray-800">사용자</p>
                        <p id="user-role-display" class="text-xs text-gray-500">학생</p>
                    </div>
                    <button onclick="logout()" class="text-xs text-gray-400 hover:text-red-500 underline">로그아웃</button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
            <section class="lg:col-span-4 space-y-4">
                <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-indigo-500">
                    <h2 class="text-lg font-bold text-gray-700 mb-4">내 자산 현황</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-end">
                            <span class="text-gray-500 text-sm">총 평가 자산</span>
                            <span id="total-asset" class="text-2xl font-bold text-gray-900">50,000,000</span>
                        </div>
                        <div class="flex justify-between items-end border-t pt-2">
                            <span class="text-gray-500 text-sm">보유 현금</span>
                            <span id="cash-balance" class="text-lg font-semibold text-gray-700">50,000,000</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <span class="text-gray-500 text-sm">투자 손익</span>
                            <span id="total-profit" class="text-lg font-semibold text-gray-500">0 (0.00%)</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6 h-[500px] flex flex-col">
                    <h2 class="text-lg font-bold text-gray-700 mb-4">내 포트폴리오</h2>
                    <div id="portfolio-list" class="flex-grow overflow-y-auto space-y-2 pr-2 scrollbar-hide">
                        <div class="text-center text-gray-400 py-10">보유 중인 주식이 없습니다.</div>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-8 space-y-6">
                <div class="bg-gray-800 text-white rounded-lg p-3 shadow flex items-center overflow-hidden">
                    <span class="bg-red-600 text-xs font-bold px-2 py-1 rounded mr-3 flex-shrink-0 animate-pulse">LIVE</span>
                    <div class="overflow-hidden relative w-full h-6">
                        <div id="news-ticker" class="absolute whitespace-nowrap">
                            장 시작 대기 중입니다...
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-5 max-h-96 overflow-y-auto custom-scrollbar">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h2 class="text-lg font-bold text-gray-700">📰 실시간 시장 뉴스</h2>
                        <span class="text-[10px] text-gray-400">※ 주요 뉴스를 클릭하면 기사 전문이 나옵니다.</span>
                    </div>
                    <div id="news-feed-list" class="space-y-2 text-sm"></div>
                </div>

                <div class="bg-white rounded-xl shadow-lg flex flex-col h-[550px]">
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                        <h2 class="text-lg font-bold text-gray-700">KOSPI 주요 종목</h2>
                        <span class="text-xs text-gray-500">* 실시간 시세 반영</span>
                    </div>
                    
                    <div class="grid grid-cols-12 gap-2 px-4 py-2 bg-gray-100 text-xs font-bold text-gray-500">
                        <div class="col-span-4">종목명</div>
                        <div class="col-span-3 text-right">현재가</div>
                        <div class="col-span-3 text-right">등락률</div>
                        <div class="col-span-2 text-center">분석/주문</div>
                    </div>

                    <div id="stock-list" class="flex-grow overflow-y-auto divide-y divide-gray-100"></div>
                </div>
            </section>
        </main>

        <div id="admin-panel" class="hidden fixed bottom-4 right-4 bg-gray-900 text-white p-4 rounded-xl shadow-2xl z-50 opacity-90 hover:opacity-100 transition border-2 border-yellow-500 w-80 max-h-[80vh] flex flex-col">
            <h3 class="font-bold text-yellow-400 mb-3 text-center border-b border-gray-700 pb-2">👑 관리자 모드 (V32)</h3>
            
            <div class="flex-grow overflow-y-auto space-y-2 pr-1 scrollbar-hide text-xs">
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="adminFunc('start')" class="bg-green-600 hover:bg-green-700 py-2 rounded font-bold">▶ 개장</button>
                    <button onclick="adminFunc('stop')" class="bg-red-600 hover:bg-red-700 py-2 rounded font-bold">⛔ 마감</button>
                </div>

                <div class="mt-2 mb-4 pt-2 border-t border-gray-700">
                    <button onclick="openBigRanking()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 rounded shadow-lg transform transition hover:scale-105">
                        📺 대형 랭킹판 띄우기
                    </button>
                </div>

                <div class="text-center text-gray-400 text-[10px] mb-1">- 수업 시나리오 (기사 송출) -</div>
                
                <div class="grid grid-cols-2 gap-1">
                    <button onclick="runScenario(1)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left">09:30 산타랠리</button>
                    <button onclick="runScenario(2)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left">10:00 차익실현</button>
                    <button onclick="runScenario(3)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left">10:30 환율 수혜</button>
                    <button onclick="runScenario(4)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left">11:00 어닝 시즌</button>
                    <button onclick="runScenario(5)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left">11:30 환율 피해</button>
                    <button onclick="runScenario(6)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left">12:00 점심 관망</button>
                    <button onclick="runScenario(7)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left text-yellow-300">13:30 성장주 반등</button>
                    <button onclick="runScenario(8)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left text-yellow-300">14:00 실적 점프</button>
                    <button onclick="runScenario(9)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left text-yellow-300">14:30 기관 폭매수</button>
                    <button onclick="runScenario(10)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left text-yellow-300">15:00 배당주 관리</button>
                    <button onclick="runScenario(11)" class="px-2 py-1 bg-gray-800 hover:bg-indigo-900 rounded text-left text-yellow-300">15:30 윈도우 드레싱</button>
                </div>

                <div class="h-4 border-b border-gray-700 mb-2"></div>
                <button onclick="adminFunc('reset')" class="w-full bg-black border border-red-500 text-red-500 hover:bg-red-900 py-2 rounded">⚠️ 데이터 전체 초기화</button>
            </div>
        </div>
    </div>

    <div id="trade-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <div>
                    <h3 id="modal-stock-name" class="text-xl font-bold text-gray-900">삼성전자</h3>
                    <span id="modal-stock-code" class="text-xs text-gray-500 bg-gray-200 px-2 py-0.5 rounded">005930</span>
                    <span id="modal-sector" class="text-xs font-bold text-indigo-600 ml-2">IT Sector</span>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 font-bold text-xl">✕</button>
            </div>

            <div class="p-6 overflow-y-auto max-h-[80vh]">
                <div class="mb-6">
                    <canvas id="stockChart" width="400" height="200"></canvas>
                </div>

                <div class="bg-indigo-50 p-3 rounded-lg mb-6 text-sm text-indigo-800">
                    <span class="font-bold">📢 기업 정보:</span>
                    <span id="modal-desc">정보 로딩 중...</span>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm text-gray-600">현재가</span>
                    <span id="modal-price" class="text-3xl font-bold text-indigo-600">70,000</span>
                </div>

                <div class="flex mb-4 bg-gray-100 p-1 rounded-lg">
                    <button onclick="setTradeType('buy')" id="tab-buy" class="flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-red-600 transition">매수</button>
                    <button onclick="setTradeType('sell')" id="tab-sell" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-blue-600 transition">매도</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">수량</label>
                        <div class="flex items-center">
                            <input type="number" id="trade-qty" value="1" min="1" class="flex-grow p-2 border border-gray-300 rounded-l-lg text-center focus:outline-none focus:border-indigo-500" oninput="calcTotal()">
                            <button onclick="setMaxQty()" class="px-3 py-2 bg-gray-200 text-xs font-bold text-gray-600 rounded-r-lg hover:bg-gray-300">최대</button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">주문 총액</span>
                        <div id="trade-total" class="text-right">0원</div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>가용 자산/보유</span>
                        <span id="available-asset">0원</span>
                    </div>
                </div>

                <button id="btn-execute" onclick="executeOrder()" class="w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition">
                    매수 주문
                </button>
            </div>
        </div>
    </div>

    <div id="article-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden relative flex flex-col max-h-[90vh]">
            <div class="bg-gray-50 border-b-2 border-gray-800 p-6">
                <div class="flex justify-between items-start mb-2">
                    <span id="article-time" class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">속보</span>
                    <button onclick="closeArticleModal()" class="text-gray-400 hover:text-black text-2xl font-bold">✕</button>
                </div>
                <h2 id="article-title" class="text-3xl font-black text-gray-900 leading-tight article-font mt-2">
                    기사 제목이 들어갑니다.
                </h2>
                <p class="text-gray-500 text-sm mt-3 text-right">대건경제 | <b>김동관 기자</b></p>
            </div>
            
            <div class="p-8 overflow-y-auto article-font text-gray-800 text-xl leading-loose text-justify bg-white custom-scrollbar">
                <div id="article-content">
                    본문 내용이 들어갑니다.
                </div>
            </div>

            <div class="p-4 bg-gray-100 text-center border-t text-xs text-gray-500">
                Copyright ⓒ 대건고등학교 모의투자 시스템 All rights reserved.
            </div>
        </div>
    </div>

    <div id="big-ranking-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[100] flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[90%] h-[90%] rounded-2xl shadow-2xl p-8 flex flex-col relative overflow-hidden">
            <div class="flex justify-between items-center border-b-4 border-indigo-500 pb-4 mb-4">
                <h1 class="text-4xl font-black text-gray-800 tracking-tight">👑 실시간 부자 랭킹 TOP 50</h1>
                <button onclick="closeBigRanking()" class="text-3xl font-bold text-gray-400 hover:text-red-500 transition">✕ 닫기</button>
            </div>
            <div class="flex-1 overflow-y-auto pr-4 custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-white z-10 shadow-sm">
                        <tr class="text-xl text-gray-500 border-b-2 border-gray-200">
                            <th class="p-4 w-[15%]">순위</th>
                            <th class="p-4 w-[45%]">이름</th>
                            <th class="p-4 w-[40%] text-right">총 자산</th>
                        </tr>
                    </thead>
                    <tbody id="big-ranking-list" class="text-2xl font-bold text-gray-700"></tbody>
                </table>
            </div>
            <div class="text-center text-gray-400 mt-4 text-lg">
                ※ 실시간 데이터입니다. (F11을 눌러 전체화면으로 보여주세요)
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, runTransaction, serverTimestamp, increment, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const manualConfig = {
            apiKey: "AIzaSyDrhxV67EB2a9ZsKOs6XCMDPCaPJorgEyw",
            authDomain: "ge-stock-project.firebaseapp.com",
            projectId: "ge-stock-project",
            storageBucket: "ge-stock-project.firebasestorage.app",
            messagingSenderId: "269147597454",
            appId: "1:269147597454:web:91a4e847bc6de3343f37df",
            measurementId: "G-WV45GCRSHL"
        };
        const appId = 'stock-school-sim';

        let app, db, auth;
        try {
            app = initializeApp(manualConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            document.getElementById('db-status').textContent = "데이터베이스 연결 완료";
            document.getElementById('db-status').className = "mt-2 font-bold text-green-500";
        } catch(e) {
            document.getElementById('db-status').textContent = "설정 오류: " + e.message;
            document.getElementById('db-status').className = "mt-2 font-bold text-red-500";
        }

        const VIRTUAL_MARKET_DEPTH = 500000; 
        const FEE_RATES = { buy: 0.0015, sell: 0.003 };
        const ADMIN_EMAIL = "poiujuy0014@pess.cnehs.kr";

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; 
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        window.playSound = (type) => {
            if (type === 'buy') playTone(880, 'sine', 0.15); 
            else if (type === 'sell') playTone(440, 'triangle', 0.15); 
            else if (type === 'news_good') playTone(1200, 'sine', 0.3); 
            else if (type === 'news_bad') playTone(150, 'sawtooth', 0.4); 
            else if (type === 'news_normal') playTone(600, 'square', 0.1); 
            else if (type === 'news_forecast') playTone(800, 'sine', 0.5); 
            else if (type === 'error') playTone(200, 'sawtooth', 0.2); 
        };

        window.enableSound = () => { if(audioCtx.state === 'suspended') audioCtx.resume(); };

        const USERS_DB = [
            { name: "하미경", email: "mk3324@pess.cnehs.kr" },
            { name: "김태준", email: "poiujuy0014@pess.cnehs.kr" }, 
            { name: "강은성", email: "rkd2022@pess.cnehs.kr" },
        ];

        const INITIAL_STOCKS = [
            { code: "005930", name: "삼성전자", sector: "IT", price: 110000 }, 
            { code: "000660", name: "SK하이닉스", sector: "IT", price: 577000 },
            { code: "035420", name: "NAVER", sector: "Platform", price: 237000 }, 
            { code: "035720", name: "카카오", sector: "Platform", price: 58700 },
            { code: "006400", name: "삼성SDI", sector: "Battery", price: 283500 }, 
            { code: "011070", name: "LG이노텍", sector: "IT", price: 278000 },
            { code: "005380", name: "현대차", sector: "Auto", price: 288500 }, 
            { code: "000270", name: "기아", sector: "Auto", price: 120700 },
            { code: "373220", name: "LG에너지솔루션", sector: "Battery", price: 389500 }, 
            { code: "003670", name: "포스코퓨처엠", sector: "Battery", price: 196200 },
            { code: "012450", name: "한화에어로스페이스", sector: "Defense", price: 897000 }, 
            { code: "079550", name: "LIG넥스원", sector: "Defense", price: 416500 },
            { code: "042660", name: "한화오션", sector: "Ship", price: 110700 }, 
            { code: "329180", name: "HD현대중공업", sector: "Ship", price: 516000 },
            { code: "010140", name: "삼성중공업", sector: "Ship", price: 24950 }, 
            { code: "066570", name: "HD현대미포", sector: "Ship", price: 223000 },
            { code: "005490", name: "POSCO홀딩스", sector: "Steel", price: 306000 }, 
            { code: "004020", name: "현대제철", sector: "Steel", price: 30600 },
            { code: "004600", name: "고려아연", sector: "Steel", price: 1384000 }, 
            { code: "051910", name: "LG화학", sector: "Chem", price: 348000 },
            { code: "096770", name: "SK이노베이션", sector: "Chem", price: 106000 }, 
            { code: "011170", name: "롯데케미칼", sector: "Chem", price: 73800 },
            { code: "009830", name: "한화솔루션", sector: "Chem", price: 27400 }, 
            { code: "105560", name: "KB금융", sector: "Finance", price: 125900 },
            { code: "055550", name: "신한지주", sector: "Finance", price: 78300 }, 
            { code: "000810", name: "삼성화재", sector: "Finance", price: 493500 },
            { code: "323410", name: "카카오뱅크", sector: "Finance", price: 21900 }, 
            { code: "207940", name: "삼성바이오로직스", sector: "Bio", price: 1731000 },
            { code: "068270", name: "셀트리온", sector: "Bio", price: 183700 }, 
            { code: "000100", name: "유한양행", sector: "Bio", price: 115800 },
            { code: "004170", name: "신세계", sector: "Retail", price: 248000 }, 
            { code: "023530", name: "롯데쇼핑", sector: "Retail", price: 74200 },
            { code: "097950", name: "CJ제일제당", sector: "Food", price: 210000 }, 
            { code: "352820", name: "HYBE", sector: "Enter", price: 310000 },
            { code: "035900", name: "JYP Ent.", sector: "Enter", price: 70200 }, 
            { code: "041510", name: "에스엠", sector: "Enter", price: 117500 },
            { code: "122870", name: "와이지엔터테인먼트", sector: "Enter", price: 63600 }
        ];

        const COMPANY_DESCRIPTIONS = {
            "005930": "글로벌 메모리 반도체 1위 및 스마트폰, 가전 세계적 기업",
            "000660": "글로벌 메모리 반도체 2위, HBM 시장 선도 기업",
            "035420": "국내 1위 검색 포털 및 AI, 커머스 플랫폼 기업",
            "035720": "국민 메신저 카카오톡 기반의 모바일 라이프 플랫폼",
            "006400": "소형 배터리 및 전기차용 중대형 배터리 제조 기업",
            "011070": "모바일용 카메라 모듈 및 첨단 전자 부품 제조사",
            "005380": "글로벌 TOP3 자동차 완성차 제조업체",
            "000270": "디자인 경영을 통한 글로벌 자동차 제조업체",
            "373220": "세계 최고의 기술력을 보유한 전기차 배터리 생산 기업",
            "003670": "2차전지 양극재 및 음극재 생산 글로벌 소재 기업",
            "012450": "항공우주 및 방위산업 분야의 대한민국 대표 기업",
            "079550": "정밀 유도무기 등 첨단 무기 체계 개발 방산업체",
            "042660": "잠수함 및 특수선 분야 경쟁력을 갖춘 조선 해양 기업",
            "329180": "세계 1위 조선 기술력을 보유한 중공업 회사",
            "010140": "고부가가치 선박 및 해양 설비 전문 조선 기업",
            "066570": "중형 선박 및 PC선 분야 세계 시장 점유율 1위",
            "005490": "철강을 넘어 2차전지 소재로 도약하는 친환경 미래 소재 기업",
            "004020": "자동차용 강판 및 건설용 철강재 생산 전기로 제철소",
            "004600": "세계 최고 수준의 비철금속(아연, 납) 제련 기업",
            "051910": "석유화학, 첨단소재, 생명과학 분야의 글로벌 화학 기업",
            "096770": "정유, 화학, 윤활유 및 배터리 사업을 영위하는 에너지 기업",
            "011170": "다양한 화학 제품을 생산하는 롯데그룹의 화학 계열사",
            "009830": "태양광 에너지 및 케미칼 소재 전문 기업",
            "105560": "은행, 증권, 보험 등을 아우르는 국내 최대 금융지주",
            "055550": "디지털 혁신을 선도하는 글로벌 금융 그룹",
            "000810": "국내 손해보험 업계를 선도하는 삼성의 금융 계열사",
            "323410": "모바일 중심의 혁신적인 인터넷 전문 은행",
            "207940": "글로벌 1위 바이오 의약품 위탁 생산(CMO) 기업",
            "068270": "바이오 시밀러 및 신약 개발 글로벌 바이오 기업",
            "000100": "신약 개발(렉라자 등) 성과를 내는 존경받는 제약사",
            "004170": "백화점 및 패션, 뷰티 사업을 영위하는 유통 공룡",
            "023530": "백화점, 마트, 슈퍼 등을 운영하는 종합 유통 기업",
            "097950": "비비고 등 K-푸드 글로벌 확산의 주역인 식품 기업",
            "352820": "BTS 등 글로벌 아티스트를 보유한 엔터테인먼트 플랫폼",
            "035900": "트와이스, 스트레이키즈 등 K-POP 아이돌 명가",
            "041510": "NCT, 에스파 등 독창적 IP를 보유한 K-POP 선두주자",
            "122870": "블랙핑크, 베이비몬스터 등 글로벌 IP를 보유한 엔터 기업"
        };

        // 🟢 V32: 랜덤 뉴스 데이터 대폭 확장 (섹터별/종목별 다수 추가)
        const NEWS_TEMPLATES = {
            'Market': [
                { text: "미국 연준(Fed), 기준금리 동결 시사... 안도 랠리 기대", type: "good", impact: 0.03 },
                { text: "글로벌 경기 침체 우려 확산, 투자 심리 위축", type: "bad", impact: -0.03 },
                { text: "정부, 증시 부양 위한 밸류업 프로그램 2탄 발표", type: "good", impact: 0.02 },
                { text: "원/달러 환율 급등... 외국인 자금 이탈 우려", type: "bad", impact: -0.02 },
                { text: "국민연금, 국내 주식 비중 확대 계획 발표", type: "good", impact: 0.02 },
                { text: "중동 지정학적 리스크 고조... 국제 유가 불안", type: "bad", impact: -0.02 },
                { text: "외국인 투자자, 코스피 5일 연속 순매수 행진", type: "good", impact: 0.02 },
                { text: "미국 CPI(소비자물가지수) 예상치 하회... 금리 인하 기대감", type: "good", impact: 0.03 },
                { text: "중국 부동산 위기 재점화... 아시아 증시 전반 약세", type: "bad", impact: -0.03 }
            ],
            'IT': [
                { text: "{name}, 차세대 HBM4 반도체 수율 90% 달성 쾌거", type: "good", impact: 0.07 },
                { text: "{name}, 반도체 D램 현물 가격 하락 전환... 업황 우려", type: "bad", impact: -0.05 },
                { text: "{name}, 경쟁사와 특허 소송 승소... 배상금 수령 기대", type: "good", impact: 0.04 },
                { text: "{name}, 미국 빅테크 기업과 대규모 AI 칩 공급 계약 체결", type: "good", impact: 0.06 },
                { text: "{name}, 최신 스마트폰 사전 예약 역대 최고치 기록", type: "good", impact: 0.05 },
                { text: "{name}, 파운드리 공정 수율 부진 루머 확산에 급락", type: "bad", impact: -0.04 },
                { text: "{name}, 외국인 창구 대량 매수 유입... 주가 강세", type: "good", impact: 0.03 },
                { text: "{name}, 신규 공장 증설 계획 연기... 투자 심리 냉각", type: "bad", impact: -0.03 }
            ],
            'Platform': [
                { text: "{name}, 생성형 AI 서비스 유료 가입자 100만 돌파", type: "good", impact: 0.06 },
                { text: "{name}, 공정위 플랫폼 독과점 강력 제재안 발표", type: "bad", impact: -0.05 },
                { text: "{name}, 웹툰 자회사 나스닥 상장 구체화 소식", type: "good", impact: 0.05 },
                { text: "{name}, 광고 경기 둔화로 분기 매출 감소 우려", type: "bad", impact: -0.03 },
                { text: "{name}, 핀테크 사업 부문 흑자 전환 성공", type: "good", impact: 0.04 },
                { text: "{name}, 신규 게임 퍼블리싱 대박... 매출 급증 예상", type: "good", impact: 0.05 },
                { text: "{name}, 서버 화재로 인한 서비스 장애 발생 악재", type: "bad", impact: -0.04 }
            ],
            'Auto': [
                { text: "{name}, 북미 전기차 전용 공장 조기 가동 소식", type: "good", impact: 0.06 },
                { text: "{name}, 차량용 반도체 수급난 재점화로 생산 차질", type: "bad", impact: -0.05 },
                { text: "{name}, 노조 파업 결의... 생산 차질 우려 확대", type: "bad", impact: -0.04 },
                { text: "{name}, 자율주행 레벨3 상용화 허가 획득", type: "good", impact: 0.07 },
                { text: "{name}, 하이브리드 차량 판매 호조로 실적 방어", type: "good", impact: 0.03 },
                { text: "{name}, 미국 관세 부과 가능성 제기에 약세", type: "bad", impact: -0.03 },
                { text: "{name}, 유럽 시장 점유율 역대 최고치 경신", type: "good", impact: 0.04 },
                { text: "{name}, 대규모 리콜 사태 발생... 충당금 부담", type: "bad", impact: -0.04 }
            ],
            'Battery': [
                { text: "{name}, 차세대 전고체 배터리 시제품 공개", type: "good", impact: 0.08 },
                { text: "{name}, 전기차 캐즘(수요 둔화) 장기화 우려 지속", type: "bad", impact: -0.06 },
                { text: "{name}, 미국 IRA 보조금 축소 가능성에 긴장", type: "bad", impact: -0.04 },
                { text: "{name}, 유럽 완성차 업체와 대규모 장기 공급 계약", type: "good", impact: 0.07 },
                { text: "{name}, 리튬 가격 반등으로 재고 평가익 기대", type: "good", impact: 0.04 },
                { text: "{name}, 중국 배터리 업체 저가 공세에 점유율 하락", type: "bad", impact: -0.03 },
                { text: "{name}, 4680 원통형 배터리 양산 준비 완료", type: "good", impact: 0.05 }
            ],
            'Defense': [
                { text: "{name}, 동유럽 국가와 2조원대 무기 수출 계약 체결", type: "good", impact: 0.09 },
                { text: "{name}, 평화 협정 무드 조성에 방산주 동반 약세", type: "bad", impact: -0.05 },
                { text: "{name}, 차세대 전투기 개발 사업 우선협상대상자 선정", type: "good", impact: 0.06 },
                { text: "{name}, 우주 발사체 엔진 시험 성공 소식", type: "good", impact: 0.05 },
                { text: "{name}, 정부 국방 예산 대폭 증액 수혜 기대", type: "good", impact: 0.04 }
            ],
            'Ship': [
                { text: "{name}, 카타르발 LNG선 2차 대량 수주 잭팟", type: "good", impact: 0.07 },
                { text: "{name}, 조선소 인력난 심화로 납기 지연 우려", type: "bad", impact: -0.03 },
                { text: "{name}, 친환경 메탄올 추진선 기술 세계 최초 인증", type: "good", impact: 0.05 },
                { text: "{name}, 후판 가격 협상 난항으로 원가 부담 증가", type: "bad", impact: -0.02 },
                { text: "{name}, 3년치 일감 확보... 도크가 꽉 찼다", type: "good", impact: 0.04 }
            ],
            'Steel': [
                { text: "{name}, 중국 경기 부양책에 철강 수요 회복 기대", type: "good", impact: 0.04 },
                { text: "{name}, 건설 경기 침체로 철근 판매량 급감", type: "bad", impact: -0.03 },
                { text: "{name}, 저탄소 수소 환원 제철 기술 개발 국책 과제 선정", type: "good", impact: 0.03 },
                { text: "{name}, 원자재 철광석 가격 급등으로 마진 압박", type: "bad", impact: -0.02 }
            ],
            'Chem': [
                { text: "{name}, 국제 유가 상승으로 정제 마진 강세", type: "good", impact: 0.04 },
                { text: "{name}, 중국발 공급 과잉으로 석유화학 업황 부진", type: "bad", impact: -0.03 },
                { text: "{name}, 고부가 스페셜티 소재 비중 확대로 체질 개선", type: "good", impact: 0.05 },
                { text: "{name}, 태양광 소재 수요 급증... 실적 호조", type: "good", impact: 0.04 }
            ],
            'Finance': [
                { text: "{name}, 주주 환원 강화... 자사주 소각 및 배당 확대", type: "good", impact: 0.06 },
                { text: "{name}, 부동산 PF 부실 우려로 대손 충당금 적립 증가", type: "bad", impact: -0.04 },
                { text: "{name}, 3분기 당기순이익 사상 최대 달성", type: "good", impact: 0.04 },
                { text: "{name}, 홍콩 ELS 배상안 확정으로 일회성 비용 발생", type: "bad", impact: -0.02 },
                { text: "{name}, 금리 인하 시기 지연에 따른 이자 이익 증가", type: "good", impact: 0.03 }
            ],
            'Bio': [
                { text: "{name}, 개발 중인 항암제 미 FDA 임상 3상 통과", type: "good", impact: 0.12 },
                { text: "{name}, 임상 데이터 조작 의혹 제기로 주가 급락", type: "bad", impact: -0.10 },
                { text: "{name}, 글로벌 제약사에 1조원 규모 기술 수출(L/O)", type: "good", impact: 0.10 },
                { text: "{name}, 바이오시밀러 미국 시장 점유율 1위 달성", type: "good", impact: 0.07 },
                { text: "{name}, 신약 허가 심사 지연 소식에 실망 매물", type: "bad", impact: -0.05 },
                { text: "{name}, 대규모 생산 공장 증설 완료... CMO 수주 확대", type: "good", impact: 0.05 }
            ],
            'Enter': [
                { text: "{name}, 소속 신인 그룹 빌보드 핫100 진입 쾌거", type: "good", impact: 0.08 },
                { text: "{name}, 간판 아티스트 재계약 불발 설에 주가 휘청", type: "bad", impact: -0.08 },
                { text: "{name}, 월드 투어 전석 매진... MD 매출 역대급", type: "good", impact: 0.06 },
                { text: "{name}, 멤버 사생활 리스크로 인한 활동 중단 악재", type: "bad", impact: -0.06 },
                { text: "{name}, 신규 앨범 초동 판매량 밀리언셀러 달성", type: "good", impact: 0.05 }
            ],
            'Retail': [
                { text: "{name}, 중국인 단체 관광객(유커) 귀환에 면세점 호황", type: "good", impact: 0.05 },
                { text: "{name}, 내수 소비 위축으로 백화점 매출 역성장", type: "bad", impact: -0.03 },
                { text: "{name}, 온라인 채널 강화로 매출 구조 다변화 성공", type: "good", impact: 0.03 }
            ],
            'Food': [
                { text: "{name}, 냉동 김밥 미국 마트 완판 행진... K-푸드 열풍", type: "good", impact: 0.06 },
                { text: "{name}, 원당 및 밀가루 가격 인상으로 원가 부담 가중", type: "bad", impact: -0.02 },
                { text: "{name}, 가격 인상 단행... 수익성 개선 기대", type: "good", impact: 0.03 }
            ],
            'Default': [
                { text: "{name}, 어닝 서프라이즈(깜짝 실적) 발표", type: "good", impact: 0.05 },
                { text: "{name}, 실적 쇼크... 증권가 목표 주가 줄하향", type: "bad", impact: -0.04 },
                { text: "{name}, 외국인 10일 연속 순매수 행진", type: "good", impact: 0.03 },
                { text: "{name}, 경영권 분쟁 조짐에 단기 급등", type: "good", impact: 0.05 },
                { text: "{name}, 신규 사업 진출 선언에 기대감 솔솔", type: "good", impact: 0.04 },
                { text: "{name}, 대규모 유상증자 결정에 주가 급락", type: "bad", impact: -0.08 }
            ]
        };

        const SCENARIO_DETAILS = {
            1: {
                title: "[속보] “산타가 온다”...삼성전자, 현대차 등 대형주 주도로 코스피 ‘강세’",
                content: "연말 증시가 산타 랠리에 대한 기대감으로 뜨거워진 가운데 국내 증시를 대표하는 대형주 5인방이 시장의 상승세를 강력하게 견인하고 있습니다. 삼성전자와 sk하이닉스는 AI반도체 수요 지속에 힘입어 외국인의 집중 매수세를 받으며 IT 대장주로서의 면모를 과시중입니다. 실적 호조를 보이고 있는 현대차와 AI수익화가 가시화된 NAVER 또한 견고한 펀더멘털을 바탕으로 주가 상향 곡선을 그리고 있습니다. 여기에 POSCO가 철강 업황회복과 이차전지 소재 가치 재부각으로 힘을 보태며, 업종별 고른 상승세가 나타나고 있습니다. 전문가들은 주요 기업들의 실적 모멘텀이 확실한 만큼 이번 연말 랠리가 내년 초까지 이어질 가능성이 높다고 전망하고 있습니다."
            },
            2: {
                title: "[속보] \"차익 실현 매물에 발목\"… 주요 대형주, 저항선 부딪히며 줄하락",
                content: "장 초반 강한 상승세로 출발했던 국내 증시가 주요 종목들의 ‘기술적 저항선’ 돌파 실패와 함께 차익 실현 매물이 쏟아지며 혼조세를 보이고 있습니다. 삼성바이오로직스와 셀트리온 등 제약, 바이오 대장주들은 고점 부근의 강력한 매도 벽을 넘지 못하고 단기 이익을 확정지으려는 물량이 출현하며 하락 전환했습니다. 자동차 대표주인 기아와 IT부품주인 LG이노텍 역시 장 중 급등에 따른 피로감이 누적되면서 추가 상승 동력을 얻지 못한 채 하락폭을 키우고 있습니다. 최근 반등을 시도하던 카카오 또한 심리적 저항선에 부딪히며 단기 매도세가 유입되는 등 전반적으로 ‘상고하저’의 흐름이 뚜렷하게 나타나는 모습입니다. 전문가들은 “장 초반 과열 양상을 보인 종목들을 중심으로 기술적 조정이 이뤄지고 있다”며 “성급한 추격 매수보다는 지지선 확인 후 진입하는 신중한 접근이 필요하다”고 강조했습니다."
            },
            3: {
                title: "[속보] ”고환율이 효자”...현대차, 삼성전자 등 수출 대형주 일제히 강세",
                content: "원/달러 환율이 가파르게 상승하며 수출기업들의 가격 경쟁력과 원화 환산 이익이 커질 것이라는 기대감이 증시를 주도하고 있습니다. 현대차는 고환율 수혜를 직접적으로 누리는 대표 업종으로서 외화 결제 비중이 높은 북미 시장의 호조세와 맞물려 가파른 주가 상승을 기록중입니다. 삼성전자 역시 반도체 수출 대금 유입 시 환차익이 발생하며 수익성이 개선될 것이라는 전망에 매수세가 몰리고 있습니다. 수주 산업인 조선과 방산 분야의 HD현대중공업, 삼성중공업, 한화에어로스페이스 등도 달러 결제 기반의 계약 특성상 강력한 환율 수혜주로 부각되며 동반 신고가를 경신하고 있습니다. 시장 전문가들은 당분간 달러 강세 기조가 유지될 것으로 보이는 만큼 내수주보다는 수출 주도형 대형주 중심의 우상향 흐름이 지속될 것이라고 분석했습니다."
            },
            4: {
                title: "[속보] ‘어닝 시즌’돌입… 이차전지, 에너지 업계, 실적 확인 후 방향성 결정될 듯",
                content: "본격적인 4분기 실적 발표 시즌이 다가오면서, 국내 대표 배터리 및 에너지 기업들의 성적표에 시장의 모든 이목이 쏠리고 있습니다. 삼성SDI와 LG화학은 글로벌 전기차 수요 둔화(Chasm)와 전방 산업의 재고 조정 여파가 실제 수익성에 어느 정도 영향을 미쳤을지를 두고 투자자들의 신중한 관망세가 이어지는 분위기입니다. 양극재 등 핵심 소재를 공급하는 포스코퓨처엠 역시 리튬 가격 변동에 따른 판가 영향권에 놓여 있어, 이번 실적 발표에서 향후 가동률 회복 시점을 증명하는 것이 중요한 관건이 될 것으로 보입니다. SK이노베이션과 한화솔루션 또한 정제마진 추이와 글로벌 신재생 에너지 정책 변화라는 변수 속에 놓여 있어, 실적 가이던스(전망치)를 확인하기 전까지는 시장의 경계감이 해소되지 않는 모습입니다. 전문가들은 \"현재는 실적의 수치 자체보다 기업들이 제시할 미래 전략과 업황 회복에 대한 확신이 시장 심리를 되돌릴 핵심 열쇠가 될 것\"이라고 내다봤습니다."
            },
            5: {
                title: "[속보] ”고환율에 원가 부담 눈덩이”...내수, 수입 기업 수익성 악화 일로",
                content: "최근 원/달러 환율이 가파르게 상승하면서 원자재 수입 비중이 높은 내수기업들을 중심으로 수익성 악화에 대한 경계감이 최고조에 달하고 있습니다. CJ제일제당은 국제 곡물가 상승에 고환율 효과까지 더해지며 원가 부담이 급증함에 따라 4분기 영업이익률 유지를 위한 비상 경영 체제에 돌입한 것으로 알려졌습니다. 해외 명품 및 직수입 상품 비중이 큰 신세계와 롯데쇼핑 등 유통 업계 역시 원화 가치하락에 따른 수입 단가 상승이 마진율 저하로 이어지며 주가 하방 압력을 강하게 받고 있습니다. 원료 의약품의 상당수를 수입에 의존하는 유한양행 또한 환차손 발생 우려와 비용 증가라는 이중고를 겪으며 투자 심리가 급격히 위축되는 모습입니다. 시장 전문자들은 “수출 기업들과 달리 내수 기업들은 환율 상승분을 가격에 즉각 반영하기 어려워 당분간 실적 부진이 불가피할 것”이라며 투자 주의를 당부했습니다."
            },
            6: {
                title: "[속보] \"숫자에 집중할 시간\"… 관망세 속 가치 평가 구간 진입",
                content: "장 초반의 소란스러움이 지나고 거래량이 급감하는 정오에 들어서며 시장은 기업의 본질적 가치를 면밀히 따져보는 ‘기본적 분석’모드로 전환되었습니다. 대표적인 저주가순자산비율 종목인 KB금융과 신한지주 그리고 삼성화재 등 금융주들은 배당 매력과 이익 안정선에도 불구하고 추가 상승을 이끌 새로운 모멘텀을 기다리며 뚜렷한 방향성 없이 횡보하고 있습니다. 전통적인 산업재 종목인 고려아연과 현대제철 역시 업황 회복 기대감과 글로벌 원자재 가격 사시에서 가치 평가가 팽팽하게 맞물리며 주가가 박스권에 갇힌 모습입니다. 투자자들이 장 초반의 심리적 동요를 뒤로하고 재무제표와 실적 전망치 등 기초 체력(펀더멘탈)을 점검함에 따라 시장 전반의 변동성은 눈에 띄게 줄어들었습니다. 증권업계 관계자는 “점심시간을 기점으로 나타나는 이러한 정체 현상은 투자자들이 오후 장의 방향성을 결정하기 전 기업 가치를 재산정하는 필연적인 과정”이라고 설명했습니다."
            },
            7: {
                title: "[속보] ”던질 사람은 다 던졌다”...양도세 폭탄 뚫고 비상하는 ‘성장주’",
                content: "연말 증시의 최대 악재로 꼽히던 대주주 양도세 회피 물량이 오전 중 대거 소화되면서 억눌려 있던 성장주들이 분노의 반등을 시작했습니다. 세금부담을 피하기 위한 ‘울며 겨자먹기’식 매도세가 일단락되자 그간 기업 가치 대비 지나치게 하락했다는 ‘낙폭 과대’인식이 확산되며 저가 매수세가 무섭게 유입되고 있습니다. 플랫폼 대장주인 카카오와 NAVER는 매도 폭풍을 견뎌내고 강력한 우상향 곡선을 그리며 시장의 주도권을 탈환하고 있으며 엔터주인 JYP Ent와 HYBE 역시 수급 불균형이 해소됨과 동시에 가파른 탄력을 받으며 급등세를 연출하고 있습니다. 특히 금융 혁신의 아이콘인 카카오뱅크마저 그간의 부진을 털어내는 반등에 성공하며 시장에서는 “연말 세금 회피용 투매가 오히려 최고의 매수 기회를 제공했다”는 분석이 지배적입니다. 전문가들은 “악성 매물이 사라진 빈자리를 기관과 외국인이 빠르게 채우고 있다”며 “성장주를 중심으로 한 연말 ‘쇼트 커버링(공매도 환매수)’ 랠리가 더욱 거세질 것” 이라고 경고 섞인 전망을 내놓았습니다."
            },
            8: {
                title: "[속보] \"성장의 한계는 없다\"… 주요 대기업, 압도적 실적 앞세워 '퀀텀 점프' 예고",
                content: "국내 주요 산업을 이끄는 핵심 기업들이 잇따라 '어닝 서프라이즈'를 기록하며 대한민국 경제의 건재함을 과시하고 있습니다. LG에너지솔루션은 차세대 배터리 기술력과 견고한 수주 잔고를 바탕으로 역대급 실적을 달성했으며, 글로벌 시장 지배력을 더욱 공고히 하며 거침없는 성장세를 이어갈 것으로 보입니다. 방산과 조선의 주역인 LIG넥스원, 한화오션, HD현대미포 역시 전 세계적인 수주 호황에 힘입어 사상 최대 규모의 이익을 실현함과 동시에, 향후 몇 년간의 먹거리를 미리 확보하며 장기적인 우상향 궤도에 진입했습니다. 엔터 대장주 에스엠 또한 아티스트들의 강력한 글로벌 팬덤과 신규 IP의 성공적인 안착으로 수익성이 극대화되며 엔터 산업의 새로운 황금기를 주도하고 있습니다. 시장 전문가들은 \"단순한 숫자를 넘어 기업들의 본질적인 기초 체력이 강화되었다는 점이 고무적\"이라며, \"현재의 압도적인 성과가 향후 기업 가치를 한 단계 더 끌어올리는 강력한 발판이 될 것\"이라고 일제히 장밋빛 전망을 내놓았습니다."
            },
            9: {
                title: "[속보] \"산타의 역습\"… 장 막판 기관 '묻지마 매수'에 대형주 대폭발",
                content: "장 마감을 불과 한 시간 앞두고 시장의 의구심을 단번에 날려버리는 기관의 '폭격기'급 매수세가 유입되며, 코스피 대장주들이 일제히 수직 상승하는 진풍경이 벌어지고 있습니다. 연말 산타 랠리의 실종을 우려하던 목소리는 순식간에 사라졌고, 삼성전자와 SK하이닉스는 반도체 업황의 장밋빛 미래를 확신한 기관의 싹쓸이 매수에 힘입어 장중 고점을 무서운 기세로 돌파하고 있습니다. 현대차 역시 환율 수혜와 실적 자신감이 맞물리며 기관의 집중 타깃이 되었고, 마감 직전 매수세가 쏠리며 주가 탄력이 극대화되는 모습입니다. 철강과 비철금속의 기둥인 POSCO홀딩스와 고려아연 또한 \"지금이 아니면 못 산다\"는 식의 공격적인 기관 수급이 유입되면서, 전광판을 온통 붉은색으로 물들이는 광풍의 주인공이 되었습니다. 시장 관계자들은 \"기관이 장 막판 지수 대형주를 이토록 강하게 끌어올리는 것은 내년 초 장세에 대한 강력한 확신이 서지 않고서는 불가능한 일\"이라며, \"오늘의 라스트 아워는 단순한 반등을 넘어 역대급 연말 랠리의 서막을 알리는 신호탄\"이라고 흥분을 감추지 못했습니다."
            },
            10: {
                title: "[속보] \"찬바람 불면 역시 배당주\"… 막판 종가 관리 매수세에 '함박웃음'",
                content: "본격적인 연말 배당락일을 앞두고 배당 수익을 확보하려는 기관과 외국인의 '막판 스퍼트'가 이어지며 주요 고배당주들이 일제히 강세로 장을 마감했습니다. 금융 대장주인 KB금융과 신한지주는 안정적인 이익 체력과 높은 배당 성향이 다시 한번 부각되면서, 장 마감 직전까지 종가 관리를 위한 대규모 프로그램 매수세가 유입되었습니다. 삼성화재 역시 역대급 실적에 따른 배당 확대 기대감이 주가를 밀어 올렸으며, 전통적인 배당 강자인 현대제철 또한 저평가 매력과 배당 매력이 동시에 부각되며 견조한 상승세를 유지했습니다. 특히 기아는 강력한 주주 환원 정책과 실적 호조가 맞물리며 배당주를 찾는 투자자들의 '원픽'으로 꼽혀, 장 막판까지 매수 우위의 흐름을 보였습니다. 증권업계에서는 \"찬바람이 불기 시작하면 배당주로 몰리는 수급의 법칙이 올해도 증명되었다\"며 \"안정적인 배당 수익과 주가 상승이라는 두 마리 토끼를 잡으려는 스마트 머니의 이동이 뚜렷하다\"고 분석했습니다."
            },
            11: {
                title: "[속보] \"시장의 광기, 브레이크가 없다\"… 기관들의 처절한 '윈도우 드레싱'에 증시 폭발",
                content: "연말 수익률 성적표를 받아들기 직전, 기관 투자자들이 수단과 방법을 가리지 않고 주가를 끌어올리는 이른바 '윈도우 드레싱' 작전에 돌입하며 시장이 통제 불능의 광풍 속으로 빨려 들어가고 있습니다. 삼성전자와 현대차 등 지수 대장주들은 기관들의 처절한 '물량 쓸어담기'에 힘입어 전고점을 힘없이 파괴하며 수직 상승 중이며, 전광판은 오직 붉은색 숫자로만 도배되는 경이로운 광경이 펼쳐지고 있습니다. 금융의 핵 KB금융과 바이오 거물 삼성바이오로직스 역시 수익률 극대화를 노린 기관의 무차별적인 '묻지마 매수'에 직면하며, 상식적인 분석을 뛰어넘는 폭발적 시세를 분출하고 있습니다. 철강왕 POSCO홀딩스와 플랫폼의 상징 NAVER마저 기관들의 '수익률 세탁'을 위한 마지막 퍼즐로 지목되어, 장 마감 직전까지 거침없는 매수 폭격 속에 동반 신고가 경신이라는 전율의 드라마를 써 내려가고 있습니다. 시장 전문가들은 \"이것은 투자가 아니라 전쟁이다\"라며, \"펀더멘털을 완전히 무시한 채 오직 장부상 수익률을 높이기 위한 기관들의 광기 어린 '종가 조작급' 매수세가 오늘 증시를 완전히 지배했다\"고 혀를 내둘렀습니다."
            }
        };

        const SCENARIOS_DATA = {
            1: { time: "오전 9:30", targets: ["005930", "000660", "005380", "035420", "005490"], delta: 0.18 },
            2: { time: "오전 10:00", targets: ["207940", "068270", "000270", "011070", "035720"], delta: -0.15 },
            3: { time: "오전 10:30", targets: ["005380", "005930", "329180", "012450", "010140"], delta: 0.15 },
            4: { time: "오전 11:00", targets: ["006400", "051910", "003670", "096770", "009830"], delta: -0.20 },
            5: { time: "오전 11:30", targets: ["097950", "004170", "023530", "000100"], delta: -0.12 },
            6: { time: "오후 12:00", targets: ["105560", "055550", "000810", "004600", "004020"], delta: 0.005 },
            7: { time: "오후 1:30", targets: ["035720", "035420", "035900", "352820", "323410"], delta: 0.20 },
            8: { time: "오후 2:00", targets: ["373220", "079550", "042660", "066570", "041510"], delta: -0.22 },
            9: { time: "오후 2:30", targets: ["005930", "000660", "005380", "005490", "004600"], delta: 0.18 },
            10: { time: "오후 3:00", targets: ["105560", "000810", "055550", "004020", "000270"], delta: 0.05 },
            11: { time: "오후 3:30", targets: ["005930", "005380", "105560", "207940", "005490", "035420"], delta: 0.10 }
        };

        let currentUser = null;
        let marketData = {}; 
        let userPortfolio = { cash: 50000000, holdings: {} };
        let tradeState = { type: 'buy', code: null };
        let gameState = { day: 1, isOpen: false, gameVersion: 0, time: "09:00" }; 
        let allUsersCache = []; 
        let chartInstance = null;

        window.showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            let bgClass = "bg-blue-600";
            if(type === 'success') bgClass = "bg-green-600";
            if(type === 'error') bgClass = "bg-red-600";
            if(type === 'warning') bgClass = "bg-orange-500";
            if(type === 'forecast') bgClass = "bg-purple-600"; 

            el.className = `toast-enter transform transition-all duration-300 pointer-events-auto flex items-center p-4 rounded-lg shadow-lg text-white ${bgClass}`;
            let icon = "ℹ️";
            if(type === 'success') icon = "✅";
            if(type === 'error') icon = "⚠️";
            if(type === 'warning') icon = "🔔";
            if(type === 'forecast') icon = "🔮";

            el.innerHTML = `<span class="text-xl mr-3">${icon}</span><span class="font-medium text-sm">${message}</span>`;
            container.appendChild(el);
            
            setTimeout(() => {
                el.classList.remove('toast-enter');
                el.classList.add('toast-exit');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };

        // 🟢 V31: 랜덤 뉴스 주기 변경 (40초 ~ 60초)
        function startAutoNewsLoop() {
            if (!currentUser || currentUser.role !== 'admin') return;
            const minDelay = 40000;
            const maxDelay = 60000;
            const delay = Math.floor(Math.random() * (maxDelay - minDelay + 1)) + minDelay;
            setTimeout(async () => {
                if (gameState.isOpen) {
                    await triggerRandomNews();
                }
                startAutoNewsLoop();
            }, delay);
        }

        async function login(e) {
            e.preventDefault(); 
            window.enableSound(); 
            const name = document.getElementById('login-name').value.trim();
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            let userRecord = USERS_DB.find(u => u.name === name && u.email === email);
            if (!userRecord) {
                if (email.endsWith('@pess.cnehs.kr') || email.endsWith('@nonsandaegeon.cnehs.kr')) {
                    userRecord = { name: name, email: email };
                } else if (email !== "test@school.kr") {
                    document.getElementById('login-msg').textContent = "학교 이메일이 아니거나 명단에 없습니다.";
                    return;
                }
            }
            let role = (email === ADMIN_EMAIL) ? 'admin' : 'student';
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                const docId = email.replace(/[^a-zA-Z0-9]/g, '_'); 
                const userRef = doc(db, `artifacts/${appId}/users`, docId);
                const snap = await getDoc(userRef);
                if (!snap.exists()) {
                    await setDoc(userRef, {
                        name: name, email: email, role: role,
                        cash: 50000000, holdings: {}, transactions: [],
                        totalAssets: 50000000, dataVersion: 0, lastUpdate: serverTimestamp()
                    });
                }
                currentUser = { uid: docId, name, email, role };
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                setupUI();
                startRealtimeSync();
                showToast(`환영합니다, ${name}님!`, 'success');
                playSound('buy'); 

                if (role === 'admin') {
                    startAutoNewsLoop();
                }

            } catch (err) {
                console.error(err);
                document.getElementById('login-msg').textContent = "로그인 오류: " + err.message;
            }
        }

        window.logout = () => { auth.signOut(); location.reload(); };

        function startRealtimeSync() {
            const marketRef = doc(db, `artifacts/${appId}/public/market_state`);
            onSnapshot(marketRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    marketData = data.stocks || {};
                    gameState = { day: data.day || 1, isOpen: data.isOpen, gameVersion: data.gameVersion || 1, time: data.time || "09:00" };
                    await checkAndResetUserData(gameState.gameVersion);
                    updateMarketUI(); 
                } else if (currentUser.role === 'admin') {
                    initMarketData();
                }
            });
            const myRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            onSnapshot(myRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    userPortfolio = { cash: data.cash, holdings: data.holdings || {} };
                    updatePortfolioUI();
                }
            });
            const newsRef = doc(db, `artifacts/${appId}/public/news`);
            onSnapshot(newsRef, (doc) => {
                if (doc.exists()) {
                    updateNewsUI(doc.data().items || []);
                }
            });
        }
        
        async function checkAndResetUserData(globalVersion) {
            const userRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const userData = userSnap.data();
                if ((userData.dataVersion || 0) < globalVersion) {
                    await setDoc(userRef, {
                        name: currentUser.name, email: currentUser.email, role: currentUser.role,
                        cash: 50000000, holdings: {}, transactions: [],
                        totalAssets: 50000000, dataVersion: globalVersion, lastUpdate: serverTimestamp()
                    });
                    showToast("새 게임 시작! 자산이 초기화되었습니다.", 'warning');
                }
            }
        }

        window.adminFunc = async (action) => {
            if (currentUser.role !== 'admin') { showToast("권한이 없습니다.", 'error'); return; }
            const marketRef = doc(db, `artifacts/${appId}/public/market_state`);
            if (action === 'start') {
                await updateDoc(marketRef, { isOpen: true });
                showToast("시장이 시작되었습니다!", 'success');
            } else if (action === 'stop' || action === 'close') {
                await updateDoc(marketRef, { isOpen: false });
                showToast("장이 마감되었습니다.", 'info');
            } else if (action === 'reset') {
                if(confirm("정말 초기화하시겠습니까?")) await resetGameGlobal();
            }
        };

        async function triggerRandomNews() {
            if (currentUser.role !== 'admin') return;

            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
            const codes = Object.keys(marketData);
            if(codes.length === 0) return;
            const isMarketEvent = Math.random() < 0.2; 
            let selectedCodes = [];
            let newsText = "";
            let impactRate = 0;
            let newsType = "normal";
            const updates = {}; 

            if (isMarketEvent) {
                const templateList = NEWS_TEMPLATES['Market'];
                const template = templateList[Math.floor(Math.random() * templateList.length)];
                newsText = template.text;
                newsType = template.type;
                impactRate = template.impact;
                selectedCodes = codes; 
            } else {
                const mainCode = codes[Math.floor(Math.random() * codes.length)];
                const mainStock = marketData[mainCode];
                const sector = mainStock.sector;
                const templateList = NEWS_TEMPLATES[sector] || NEWS_TEMPLATES['Default']; // 🟢 섹터별 템플릿 우선 적용
                const template = templateList[Math.floor(Math.random() * templateList.length)];
                newsText = template.text.replace("{name}", mainStock.name);
                newsType = template.type;
                impactRate = template.impact;
                selectedCodes = codes.filter(c => marketData[c].sector === sector);
            }

            selectedCodes.forEach(code => {
                const stock = marketData[code];
                let localImpact = impactRate;
                if (!isMarketEvent && newsText.includes(stock.name)) {
                    localImpact = impactRate * (0.9 + Math.random() * 0.3); 
                } else if (!isMarketEvent) {
                    localImpact = impactRate * 0.3 * (0.5 + Math.random() * 1.0); 
                } else {
                    localImpact = impactRate * (0.8 + Math.random() * 0.4);
                }
                let newPrice = Math.round(stock.price * (1 + localImpact));
                if (newPrice < 1) newPrice = 1;
                let history = stock.history || [];
                history.push(newPrice);
                if (history.length > 30) history.shift();
                updates[`stocks.${code}.price`] = newPrice;
                updates[`stocks.${code}.change`] = newPrice - stock.basePrice;
                updates[`stocks.${code}.rate`] = ((newPrice - stock.basePrice) / stock.basePrice) * 100;
                updates[`stocks.${code}.history`] = history;
            });

            const newsRef = doc(db, `artifacts/${appId}/public/news`);
            const newsSnap = await getDoc(newsRef);
            let currentNews = newsSnap.exists() ? newsSnap.data().items : [];
            const newEvent = { time: timeString, text: newsText, type: newsType };
            const newNewsList = [newEvent, ...currentNews].slice(0, 20);
            await updateDoc(newsRef, { items: newNewsList });
            const marketRef = doc(db, `artifacts/${appId}/public/market_state`);
            await updateDoc(marketRef, updates);
        }

        window.runScenario = async (scenarioId) => {
            if (currentUser.role !== 'admin') return;
            const scenario = SCENARIOS_DATA[scenarioId];
            const detail = SCENARIO_DETAILS[scenarioId];
            if (!scenario) return;

            const newsRef = doc(db, `artifacts/${appId}/public/news`);
            const newsSnap = await getDoc(newsRef);
            let currentNews = newsSnap.exists() ? newsSnap.data().items : [];
            
            const newEvent = {
                time: scenario.time, 
                text: detail.title,
                fullTitle: detail.title, 
                fullContent: detail.content,
                type: 'forecast' 
            };
            const newNewsList = [newEvent, ...currentNews].slice(0, 20);
            await updateDoc(newsRef, { items: newNewsList });
            showToast(`[전송] ${scenario.time} 기사 송출 완료. (5분 후 주가 반영)`, 'forecast');

            setTimeout(async () => {
                const updates = {};
                Object.keys(marketData).forEach(code => {
                    const stock = marketData[code];
                    let changePct = (Math.random() * 0.02) - 0.01; 
                    if (scenario.targets.includes('all')) {
                        changePct = scenario.delta * (0.9 + Math.random() * 0.2);
                    }
                    else if (scenario.targets.includes(code)) {
                        changePct = scenario.delta * (0.9 + Math.random() * 0.2); 
                    }
                    let newPrice = Math.round(stock.price * (1 + changePct));
                    if (newPrice < 1) newPrice = 1;
                    let history = stock.history || [];
                    history.push(newPrice);
                    if (history.length > 30) history.shift();
                    updates[`stocks.${code}.price`] = newPrice;
                    updates[`stocks.${code}.change`] = newPrice - stock.basePrice;
                    updates[`stocks.${code}.rate`] = ((newPrice - stock.basePrice) / stock.basePrice) * 100;
                    updates[`stocks.${code}.history`] = history;
                });
                const marketRef = doc(db, `artifacts/${appId}/public/market_state`);
                await updateDoc(marketRef, updates);
                showToast(`[반영] ${scenario.time} 시나리오 주가 변동 적용됨!`, 'warning');
            }, 300000); 
        };

        async function resetGameGlobal() {
            const initialData = {};
            INITIAL_STOCKS.forEach(s => {
                initialData[s.code] = {
                    name: s.name, price: s.price, basePrice: s.price,
                    change: 0, rate: 0, sector: s.sector,
                    history: [s.price]
                };
            });
            await setDoc(doc(db, `artifacts/${appId}/public/market_state`), {
                day: 1, isOpen: false, stocks: initialData, gameVersion: increment(1), time: "09:00"
            }, { merge: true });
            setDoc(doc(db, `artifacts/${appId}/public/news`), { items: [] });
            showToast("전체 데이터 초기화 완료.", 'warning');
        }

        async function initMarketData() {
            const initialData = {};
            INITIAL_STOCKS.forEach(s => {
                initialData[s.code] = {
                    name: s.name, price: s.price, basePrice: s.price,
                    change: 0, rate: 0, sector: s.sector,
                    history: [s.price]
                };
            });
            await setDoc(doc(db, `artifacts/${appId}/public/market_state`), {
                day: 1, isOpen: false, stocks: initialData, gameVersion: 1, time: "09:00"
            }, { merge: true });
        }

        window.openTradeModal = (code) => {
            if (!gameState.isOpen) {
                showToast("현재 장이 마감되었습니다. 거래할 수 없습니다.", 'error');
                return;
            }
            const stock = marketData[code];
            tradeState.code = code;
            tradeState.type = 'buy';
            document.getElementById('modal-stock-name').innerText = stock.name;
            document.getElementById('modal-stock-code').innerText = code;
            document.getElementById('modal-sector').innerText = stock.sector + " Sector";
            
            // 🟢 V31: 기업 설명 복구 확인 및 적용
            const desc = COMPANY_DESCRIPTIONS[code] || "대한민국 대표 우량 기업입니다.";
            document.getElementById('modal-desc').innerText = desc;
            
            document.getElementById('trade-qty').value = 1;
            updateModalUI();
            document.getElementById('trade-modal').classList.remove('hidden');
            renderChart(stock.history || [stock.price], stock.name);
        };

        function renderChart(data, label) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: data.length}, (_, i) => i + 1),
                    datasets: [{ label: label + ' 주가', data: data, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 0 }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { beginAtZero: false, grid: { display: true, color: '#f3f4f6' } } }, animation: { duration: 0 } }
            });
        }

        window.setTradeType = (type) => {
            tradeState.type = type;
            const btnBuy = document.getElementById('tab-buy');
            const btnSell = document.getElementById('tab-sell');
            const btnExec = document.getElementById('btn-execute');
            if (type === 'buy') {
                btnBuy.className = "flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-red-600 transition";
                btnSell.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-blue-600 transition";
                btnExec.className = "w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition";
                btnExec.innerText = "매수 주문";
            } else {
                btnSell.className = "flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-blue-600 transition";
                btnBuy.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-red-600 transition";
                btnExec.className = "w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition";
                btnExec.innerText = "매도 주문";
            }
            updateModalUI();
        };

        window.calcTotal = () => updateModalUI();

        function updateModalUI() {
            const stock = marketData[tradeState.code];
            const price = stock.price;
            const qty = parseInt(document.getElementById('trade-qty').value) || 0;
            const rawTotal = price * qty;
            const feeRate = tradeState.type === 'buy' ? FEE_RATES.buy : FEE_RATES.sell;
            const fee = Math.floor(rawTotal * feeRate);
            let finalTotal = 0;
            let feeText = "";
            if (tradeState.type === 'buy') {
                finalTotal = rawTotal + fee;
                feeText = `(수수료 ${fee.toLocaleString()}원 포함)`;
            } else {
                finalTotal = rawTotal - fee;
                feeText = `(세금/수수료 ${fee.toLocaleString()}원 차감)`;
            }
            document.getElementById('modal-price').innerText = price.toLocaleString();
            document.getElementById('trade-total').innerHTML = `${finalTotal.toLocaleString()}원 <br><span class="text-xs text-gray-400 font-normal">${feeText}</span>`;
            const holdings = userPortfolio.holdings || {};
            const myHolding = holdings[tradeState.code] || { quantity: 0 };
            if (tradeState.type === 'buy') {
                document.getElementById('available-asset').innerText = "가용: " + userPortfolio.cash.toLocaleString() + "원";
            } else {
                document.getElementById('available-asset').innerText = "보유: " + myHolding.quantity + "주";
            }
        }

        window.setMaxQty = () => {
            const stock = marketData[tradeState.code];
            if (tradeState.type === 'buy') {
                const maxBuyable = Math.floor(userPortfolio.cash / (stock.price * (1 + FEE_RATES.buy)));
                document.getElementById('trade-qty').value = maxBuyable;
            } else {
                const holdings = userPortfolio.holdings || {};
                const holding = holdings[tradeState.code] || { quantity: 0 };
                document.getElementById('trade-qty').value = holding.quantity;
            }
            updateModalUI();
        }

        window.closeModal = () => document.getElementById('trade-modal').classList.add('hidden');

        window.executeOrder = async () => {
            if (!gameState.isOpen) {
                showToast("장이 마감되어 주문할 수 없습니다.", 'error');
                return;
            }
            const qty = parseInt(document.getElementById('trade-qty').value);
            if (qty <= 0) {
                showToast("수량을 입력하세요.", 'warning');
                return;
            }
            const code = tradeState.code;
            const marketRef = doc(db, `artifacts/${appId}/public/market_state`);
            const userRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            try {
                await runTransaction(db, async (transaction) => {
                    const marketDoc = await transaction.get(marketRef);
                    const userDoc = await transaction.get(userRef);
                    if (!marketDoc.exists() || !userDoc.exists()) throw "Data Error";
                    const marketState = marketDoc.data();
                    const userData = userDoc.data();
                    if (!marketState.isOpen) throw "Market Closed";
                    const stock = marketState.stocks[code];
                    const currentPrice = stock.price;
                    const rawAmount = currentPrice * qty;
                    let finalAmount = 0;
                    let newHoldings = { ...userData.holdings };
                    let newCash = userData.cash;
                    let stockHolding = newHoldings[code] ? { ...newHoldings[code] } : { quantity: 0, avgPrice: 0 };
                    if (tradeState.type === 'buy') {
                        const fee = Math.floor(rawAmount * FEE_RATES.buy);
                        finalAmount = rawAmount + fee;
                        if (newCash < finalAmount) throw "잔액 부족 (수수료 포함)";
                        newCash -= finalAmount;
                        const newQty = stockHolding.quantity + qty;
                        stockHolding.avgPrice = Math.round(((stockHolding.quantity * stockHolding.avgPrice) + finalAmount) / newQty);
                        stockHolding.quantity = newQty;
                        newHoldings[code] = stockHolding;
                    } else {
                        if (stockHolding.quantity < qty) throw "주식 부족";
                        const fee = Math.floor(rawAmount * FEE_RATES.sell);
                        finalAmount = rawAmount - fee;
                        newCash += finalAmount;
                        stockHolding.quantity -= qty;
                        if (stockHolding.quantity === 0) delete newHoldings[code];
                        else newHoldings[code] = stockHolding;
                    }
                    const direction = tradeState.type === 'buy' ? 1 : -1;
                    const priceImpactPct = (qty / VIRTUAL_MARKET_DEPTH) * direction;
                    let newMarketPrice = Math.round(currentPrice * (1 + priceImpactPct));
                    if (newMarketPrice < 1) newMarketPrice = 1;
                    let history = stock.history || [];
                    history.push(newMarketPrice);
                    if (history.length > 30) history.shift();
                    transaction.update(userRef, { cash: newCash, holdings: newHoldings });
                    const updates = {};
                    updates[`stocks.${code}.price`] = newMarketPrice;
                    updates[`stocks.${code}.change`] = newMarketPrice - stock.basePrice;
                    updates[`stocks.${code}.rate`] = ((newMarketPrice - stock.basePrice) / stock.basePrice) * 100;
                    updates[`stocks.${code}.history`] = history;
                    transaction.update(marketRef, updates);
                });
                if(tradeState.type === 'buy') playSound('buy');
                else playSound('sell');
                showToast("주문이 체결되었습니다.", 'success');
                closeModal();
            } catch (e) {
                showToast("주문 실패: " + e, 'error');
            }
        };

        function setupUI() {
            document.getElementById('user-name-display').innerText = currentUser.name;
            document.getElementById('user-role-display').innerText = currentUser.role === 'admin' ? '관리자(선생님)' : '학생';
            if (currentUser.role === 'admin') document.getElementById('admin-panel').classList.remove('hidden');
        }

        function updateMarketUI() {
            const badge = document.getElementById('market-status-badge');
            if (gameState.isOpen) {
                badge.innerText = "시장 진행 중";
                badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 animate-pulse";
            } else {
                badge.innerText = "장 마감";
                badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700";
            }
            const listEl = document.getElementById('stock-list');
            listEl.innerHTML = ''; 
            INITIAL_STOCKS.forEach(initStock => {
                const code = initStock.code;
                const s = marketData[code]; 
                if (!s) return; 
                const colorClass = s.rate > 0 ? 'price-up' : (s.rate < 0 ? 'price-down' : 'text-gray-500');
                const sign = s.rate > 0 ? '▲' : (s.rate < 0 ? '▼' : '');
                const div = document.createElement('div');
                div.className = "grid grid-cols-12 gap-2 px-4 py-3 items-center hover:bg-gray-50 transition border-b border-gray-50";
                div.innerHTML = `<div class="col-span-4 font-medium text-gray-800">${s.name}<span class="block text-xs text-gray-400">${code}</span></div><div class="col-span-3 text-right font-bold ${colorClass}">${s.price.toLocaleString()}</div><div class="col-span-3 text-right text-xs ${colorClass}">${sign} ${s.rate.toFixed(2)}%</div><div class="col-span-2 text-center"><button onclick="openTradeModal('${code}')" class="bg-gray-100 hover:bg-indigo-100 text-indigo-600 px-3 py-1 rounded text-xs font-bold transition">분석/주문</button></div>`;
                listEl.appendChild(div);
            });
        }

        function updatePortfolioUI() {
            let stockValuation = 0;
            const holdingsDiv = document.getElementById('portfolio-list');
            holdingsDiv.innerHTML = '';
            const holdings = userPortfolio.holdings || {};
            Object.keys(holdings).forEach(code => {
                const qty = holdings[code].quantity;
                const avg = holdings[code].avgPrice;
                const currentPrice = marketData[code]?.price || 0;
                const value = qty * currentPrice;
                stockValuation += value;
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-gray-50 rounded-lg";
                div.innerHTML = `<div><p class="font-bold text-gray-800 text-sm">${marketData[code]?.name || code}</p><p class="text-xs text-gray-500">${qty}주 (평단 ${avg.toLocaleString()})</p></div><div class="text-right"><p class="font-bold text-gray-800 text-sm">${value.toLocaleString()}원</p></div>`;
                holdingsDiv.appendChild(div);
            });
            const total = userPortfolio.cash + stockValuation;
            const profit = total - 50000000;
            const profitRate = (profit / 50000000) * 100;
            document.getElementById('cash-balance').innerText = Math.round(userPortfolio.cash).toLocaleString();
            document.getElementById('total-asset').innerText = Math.round(total).toLocaleString();
            const profitEl = document.getElementById('total-profit');
            profitEl.innerText = `${Math.round(profit).toLocaleString()} (${profitRate.toFixed(2)}%)`;
            profitEl.className = profit >= 0 ? "text-lg font-semibold price-up" : "text-lg font-semibold price-down";
        }

        function updateNewsUI(newsList) {
            const ticker = document.getElementById('news-ticker');
            const list = document.getElementById('news-feed-list');
            if (newsList.length > 0) {
                const latest = newsList[0];
                let typeIcon = '⚪ [일반]';
                if(latest.type === 'good') typeIcon = '🔴 [호재]';
                else if(latest.type === 'bad') typeIcon = '🔵 [악재]';
                else if(latest.type === 'forecast') typeIcon = '🔮 [속보]';

                ticker.innerText = `${typeIcon} ${latest.text} (${latest.time})`;
                
                if (window.lastNewsTime !== latest.time) {
                    if (latest.type === 'good') playSound('news_good');
                    else if (latest.type === 'bad') playSound('news_bad');
                    else if (latest.type === 'forecast') playSound('news_forecast'); 
                    else playSound('news_normal');
                    
                    window.lastNewsTime = latest.time;
                    ticker.parentElement.parentElement.classList.add('news-flash');
                    setTimeout(() => ticker.parentElement.parentElement.classList.remove('news-flash'), 1000);
                }

                list.innerHTML = '';
                newsList.slice(0, 10).forEach(news => {
                    let icon = '⚪';
                    let colorClass = "";
                    let cursorClass = "";
                    let clickEvent = "";

                    if(news.type === 'good') { icon = '🔴'; colorClass = "text-red-600"; }
                    else if(news.type === 'bad') { icon = '🔵'; colorClass = "text-blue-600"; }
                    else if(news.type === 'forecast') { 
                        icon = '📰'; 
                        colorClass = "text-indigo-700 font-bold underline"; 
                        cursorClass = "cursor-pointer hover:bg-indigo-50"; 
                        clickEvent = `onclick="openArticleModal('${news.fullTitle || news.text}', '${news.fullContent || ''}', '${news.time}')"`;
                    }

                    const div = document.createElement('div');
                    div.className = `p-3 border-b border-gray-100 last:border-0 transition rounded-lg ${cursorClass}`;
                    if(clickEvent) div.setAttribute('onclick', clickEvent.replace('onclick="', '').replace('"', ''));

                    div.innerHTML = `
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>${news.time}</span>
                            ${news.type === 'forecast' ? '<span class="text-indigo-500 font-bold">Click!</span>' : ''}
                        </div>
                        <div class="flex items-start">
                            <span class="mr-2 text-lg">${icon}</span>
                            <span class="${colorClass} text-sm leading-snug">${news.text}</span>
                        </div>
                    `;
                    if(news.type === 'forecast') {
                        div.onclick = () => openArticleModal(news.fullTitle || news.text, news.fullContent, news.time);
                    }
                    
                    list.appendChild(div);
                });
            }
        }

        // 🟢 V31: 기사 모달 (자동 문단 나누기 적용)
        window.openArticleModal = (title, content, time) => {
            if(!content) return;
            
            // 텍스트 가독성을 위해 마침표 뒤에 문단 나누기 적용 (단, 내용은 건들지 않음)
            const formattedContent = content.replace(/\.(?=\s)/g, '.<br><br>');
            
            document.getElementById('article-title').innerText = title;
            document.getElementById('article-content').innerHTML = formattedContent;
            document.getElementById('article-time').innerText = time + " 속보";
            document.getElementById('article-modal').classList.remove('hidden');
        };

        window.closeArticleModal = () => {
            document.getElementById('article-modal').classList.add('hidden');
        };

        window.openBigRanking = async () => {
            const modal = document.getElementById('big-ranking-modal');
            const listEl = document.getElementById('big-ranking-list');
            modal.classList.remove('hidden');
            listEl.innerHTML = '<tr><td colspan="3" class="p-10 text-center text-gray-400 animate-pulse">데이터를 불러오는 중입니다...</td></tr>';
            try {
                const q = query(collection(db, `artifacts/${appId}/users`));
                const snapshot = await getDocs(q);
                const allUsers = [];
                snapshot.forEach(doc => { allUsers.push(doc.data()); });
                const rankedUsers = allUsers.map(user => {
                    let stockVal = 0;
                    if (user.holdings) {
                        Object.keys(user.holdings).forEach(code => {
                            const price = marketData[code]?.price || 0;
                            stockVal += user.holdings[code].quantity * price;
                        });
                    }
                    return { name: user.name, total: (user.cash || 0) + stockVal };
                });
                rankedUsers.sort((a, b) => b.total - a.total);
                let html = '';
                rankedUsers.slice(0, 50).forEach((u, index) => { 
                    const rank = index + 1;
                    let rankStyle = "text-gray-600";
                    let rowBg = "hover:bg-gray-50";
                    let icon = "";
                    if(rank === 1) { rankStyle = "text-yellow-500 text-3xl"; rowBg = "bg-yellow-50 hover:bg-yellow-100"; icon = "🥇"; }
                    else if(rank === 2) { rankStyle = "text-gray-500 text-3xl"; rowBg = "bg-gray-50 hover:bg-gray-100"; icon = "🥈"; }
                    else if(rank === 3) { rankStyle = "text-orange-600 text-3xl"; rowBg = "bg-orange-50 hover:bg-orange-100"; icon = "🥉"; }
                    html += `<tr class="border-b border-gray-100 transition ${rowBg}"><td class="p-4 ${rankStyle} font-black">${icon} ${rank}위</td><td class="p-4 font-bold text-gray-800">${u.name}</td><td class="p-4 text-right font-mono text-indigo-600">${Math.round(u.total).toLocaleString()} 원</td></tr>`;
                });
                listEl.innerHTML = html;
            } catch (e) {
                console.error(e);
                listEl.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-red-500">불러오기 실패: ${e.message}</td></tr>`;
            }
        };

        window.closeBigRanking = () => {
            document.getElementById('big-ranking-modal').classList.add('hidden');
        };

        document.getElementById('login-btn').addEventListener('click', login);
    </script>
</body>
</html>
