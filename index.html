<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ê±´ê³  ì£¼ì‹ ëª¨ì˜íˆ¬ì (V16 - Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .market-open { color: #16a34a; font-weight: 700; }
        .market-closed { color: #dc2626; font-weight: 700; }
        .price-up { color: #dc2626; } 
        .price-down { color: #2563eb; } 
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .gold-rank { background: linear-gradient(135deg, #ffd700 0%, #fdb931 100%); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .silver-rank { background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .bronze-rank { background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        .toast-exit { animation: fadeOut 0.3s ease-in forwards; }
    </style>
</head>
<body class="text-gray-800">

    <div id="toast-container" class="fixed top-5 right-5 z-[100] flex flex-col space-y-3 w-80 pointer-events-none"></div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-100">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-indigo-700 mb-2">ğŸ“ˆ ëŒ€ê±´ê³  ì£¼ì‹ ëª¨ì˜íˆ¬ì</h1>
                <p class="text-gray-500 text-sm">ì‹¤ì „ ëª¨ì˜íˆ¬ì í”Œë«í¼</p>
            </div>
            
            <form id="login-form" class="space-y-5" onsubmit="return false;">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                    <input type="text" id="login-name" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="ì´ë¦„ ì…ë ¥" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">í•™êµ ì´ë©”ì¼ (ID)</label>
                    <input type="email" id="login-email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="ì˜ˆ: id@pess.cnehs.kr" required>
                </div>
                <button id="login-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.02] active:scale-[0.98]">
                    ë¡œê·¸ì¸ ë° ì ‘ì†
                </button>
            </form>
            
            <p id="login-msg" class="mt-4 text-center text-sm font-medium text-red-500 min-h-[20px]"></p>
            
            <div class="mt-6 pt-4 border-t border-gray-100 text-xs text-gray-400 text-center">
                <p>í•™êµ ë„ë©”ì¸(@pess.cnehs.kr) ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
                <p id="db-status" class="mt-2 font-bold text-orange-500">ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹œë„ ì¤‘...</p>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden min-h-screen flex flex-col">
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-gray-800 hidden sm:block">ëª¨ì˜íˆ¬ì</h1>
                    <span id="market-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-500">ì¥ ì¤€ë¹„ ì¤‘</span>
                    <span id="simulation-time" class="text-sm font-bold text-indigo-600"></span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p id="user-name-display" class="text-sm font-bold text-gray-800">ì‚¬ìš©ì</p>
                        <p id="user-role-display" class="text-xs text-gray-500">í•™ìƒ</p>
                    </div>
                    <button onclick="logout()" class="text-xs text-gray-400 hover:text-red-500 underline">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
            <section class="lg:col-span-4 space-y-4">
                <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-indigo-500">
                    <h2 class="text-lg font-bold text-gray-700 mb-4">ë‚´ ìì‚° í˜„í™©</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-end">
                            <span class="text-gray-500 text-sm">ì´ í‰ê°€ ìì‚°</span>
                            <span id="total-asset" class="text-2xl font-bold text-gray-900">50,000,000</span>
                        </div>
                        <div class="flex justify-between items-end border-t pt-2">
                            <span class="text-gray-500 text-sm">ë³´ìœ  í˜„ê¸ˆ</span>
                            <span id="cash-balance" class="text-lg font-semibold text-gray-700">50,000,000</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <span class="text-gray-500 text-sm">íˆ¬ì ì†ìµ</span>
                            <span id="total-profit" class="text-lg font-semibold text-gray-500">0 (0.00%)</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-5">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h2 class="text-lg font-bold text-gray-700">ğŸ† ì‹¤ì‹œê°„ ë¶€ì ë­í‚¹</h2>
                        <span class="text-xs text-gray-400">ìì‚°ìˆœ</span>
                    </div>
                    <div id="ranking-list" class="space-y-2">
                        <div class="text-center text-xs text-gray-400 py-2">ë­í‚¹ ì§‘ê³„ ì¤‘...</div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6 h-[350px] flex flex-col">
                    <h2 class="text-lg font-bold text-gray-700 mb-4">ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h2>
                    <div id="portfolio-list" class="flex-grow overflow-y-auto space-y-2 pr-2 scrollbar-hide">
                        <div class="text-center text-gray-400 py-10">ë³´ìœ  ì¤‘ì¸ ì£¼ì‹ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-8 space-y-6">
                <div class="bg-gray-800 text-white rounded-lg p-3 shadow flex items-center overflow-hidden">
                    <span class="bg-red-600 text-xs font-bold px-2 py-1 rounded mr-3 flex-shrink-0 animate-pulse">ì†ë³´</span>
                    <div class="overflow-hidden relative w-full h-6">
                        <div id="news-ticker" class="absolute whitespace-nowrap">
                            ì¥ ì‹œì‘ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-5 max-h-52 overflow-y-auto">
                    <h2 class="text-lg font-bold text-gray-700 mb-3 border-b pb-2">ğŸ“° ì‹œì¥ ë‰´ìŠ¤</h2>
                    <div id="news-feed-list" class="space-y-2 text-sm"></div>
                </div>

                <div class="bg-white rounded-xl shadow-lg flex flex-col h-[550px]">
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                        <h2 class="text-lg font-bold text-gray-700">KOSPI ì£¼ìš” ì¢…ëª© (37ê°œ)</h2>
                        <span class="text-xs text-gray-500">* ë¦¬ìŠ¤íŠ¸ ê³ ì •ë¨</span>
                    </div>
                    
                    <div class="grid grid-cols-12 gap-2 px-4 py-2 bg-gray-100 text-xs font-bold text-gray-500">
                        <div class="col-span-4">ì¢…ëª©ëª…</div>
                        <div class="col-span-3 text-right">í˜„ì¬ê°€</div>
                        <div class="col-span-3 text-right">ë“±ë½ë¥ </div>
                        <div class="col-span-2 text-center">ë¶„ì„/ì£¼ë¬¸</div>
                    </div>

                    <div id="stock-list" class="flex-grow overflow-y-auto divide-y divide-gray-100"></div>
                </div>
            </section>
        </main>

        <div id="admin-panel" class="hidden fixed bottom-4 right-4 bg-gray-900 text-white p-4 rounded-xl shadow-2xl z-50 opacity-90 hover:opacity-100 transition border-2 border-yellow-500 w-48">
            <h3 class="font-bold text-yellow-400 mb-3 text-center">ğŸ‘‘ ê´€ë¦¬ì íŒ¨ë„</h3>
            <div class="space-y-2 text-xs">
                <button onclick="adminFunc('start')" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded font-bold">â–¶ ì‹œì¥ ì‹œì‘</button>
                <button onclick="adminFunc('stop')" class="w-full bg-gray-600 hover:bg-gray-700 py-3 rounded font-bold">â¸ ì‹œì¥ ì¼ì‹œì •ì§€</button>
                <button onclick="adminFunc('close')" class="w-full bg-red-600 hover:bg-red-700 py-3 rounded font-bold">â›” ì¥ ë§ˆê° (ì¢…ë£Œ)</button>
                <div class="h-2"></div>
                <button onclick="adminFunc('reset')" class="w-full bg-black border border-red-500 text-red-500 hover:bg-red-900 py-2 rounded">âš ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <div id="trade-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <div>
                    <h3 id="modal-stock-name" class="text-xl font-bold text-gray-900">ì‚¼ì„±ì „ì</h3>
                    <span id="modal-stock-code" class="text-xs text-gray-500 bg-gray-200 px-2 py-0.5 rounded">005930</span>
                    <span id="modal-sector" class="text-xs font-bold text-indigo-600 ml-2">IT Sector</span>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 font-bold text-xl">âœ•</button>
            </div>

            <div class="p-6 overflow-y-auto max-h-[80vh]">
                <div class="mb-6">
                    <canvas id="stockChart" width="400" height="200"></canvas>
                </div>

                <div class="bg-indigo-50 p-3 rounded-lg mb-6 text-sm text-indigo-800">
                    <span class="font-bold">ğŸ“¢ ê¸°ì—… ì •ë³´:</span>
                    <span id="modal-desc">ì •ë³´ ë¡œë”© ì¤‘...</span>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm text-gray-600">í˜„ì¬ê°€</span>
                    <span id="modal-price" class="text-3xl font-bold text-indigo-600">70,000</span>
                </div>

                <div class="flex mb-4 bg-gray-100 p-1 rounded-lg">
                    <button onclick="setTradeType('buy')" id="tab-buy" class="flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-red-600 transition">ë§¤ìˆ˜</button>
                    <button onclick="setTradeType('sell')" id="tab-sell" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-blue-600 transition">ë§¤ë„</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">ìˆ˜ëŸ‰</label>
                        <div class="flex items-center">
                            <input type="number" id="trade-qty" value="1" min="1" class="flex-grow p-2 border border-gray-300 rounded-l-lg text-center focus:outline-none focus:border-indigo-500" oninput="calcTotal()">
                            <button onclick="setMaxQty()" class="px-3 py-2 bg-gray-200 text-xs font-bold text-gray-600 rounded-r-lg hover:bg-gray-300">ìµœëŒ€</button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">ì£¼ë¬¸ ì´ì•¡</span>
                        <div id="trade-total" class="text-right">0ì›</div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>ê°€ìš© ìì‚°/ë³´ìœ </span>
                        <span id="available-asset">0ì›</span>
                    </div>
                </div>

                <button id="btn-execute" onclick="executeOrder()" class="w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition">
                    ë§¤ìˆ˜ ì£¼ë¬¸
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, runTransaction, serverTimestamp, increment, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const manualConfig = {
            apiKey: "AIzaSyDrhxV67EB2a9ZsKOs6XCMDPCaPJorgEyw",
            authDomain: "ge-stock-project.firebaseapp.com",
            projectId: "ge-stock-project",
            storageBucket: "ge-stock-project.firebasestorage.app",
            messagingSenderId: "269147597454",
            appId: "1:269147597454:web:91a4e847bc6de3343f37df",
            measurementId: "G-WV45GCRSHL"
        };
        const appId = 'stock-school-sim';

        let app, db, auth;
        try {
            app = initializeApp(manualConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            document.getElementById('db-status').textContent = "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì™„ë£Œ";
            document.getElementById('db-status').className = "mt-2 font-bold text-green-500";
        } catch(e) {
            document.getElementById('db-status').textContent = "ì„¤ì • ì˜¤ë¥˜: " + e.message;
            document.getElementById('db-status').className = "mt-2 font-bold text-red-500";
        }

        const VIRTUAL_MARKET_DEPTH = 500000; 
        const FEE_RATES = { buy: 0.0015, sell: 0.003 };
        const ADMIN_EMAIL = "poiujuy0014@pess.cnehs.kr";

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function beep(freq, type, duration, vol=0.1) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; 
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        window.playSound = (type) => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if (type === 'buy') { beep(880, 'sine', 0.1, 0.1); setTimeout(() => beep(1760, 'sine', 0.3, 0.1), 100); } 
            else if (type === 'sell') { beep(1200, 'triangle', 0.1, 0.1); setTimeout(() => beep(2000, 'sine', 0.4, 0.1), 80); } 
            else if (type === 'news') { beep(600, 'square', 0.1, 0.05); setTimeout(() => beep(800, 'square', 0.1, 0.05), 150); } 
            else if (type === 'error') { beep(150, 'sawtooth', 0.3, 0.1); }
        };

        // ì†Œë¦¬ ê¶Œí•œ íšë“ìš© (ë¡œê·¸ì¸ í´ë¦­ ì‹œ ì‹¤í–‰)
        window.enableSound = () => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
        };

        const USERS_DB = [
            { name: "í•˜ë¯¸ê²½", email: "mk3324@pess.cnehs.kr" },
            { name: "ê¹€íƒœì¤€", email: "poiujuy0014@pess.cnehs.kr" }, 
            { name: "ê°•ì€ì„±", email: "rkd2022@pess.cnehs.kr" },
        ];

       // [ìˆ˜ì •] ìµœì‹  ì£¼ê°€ ë°˜ì˜ (2024~2025 í˜„ì‹¤ì  ê°€ê²©ëŒ€)
        const INITIAL_STOCKS = [
            { code: "005930", name: "ì‚¼ì„±ì „ì", sector: "IT", price: 110000 }, 
            { code: "000660", name: "SKí•˜ì´ë‹‰ìŠ¤", sector: "IT", price: 577000 },
            { code: "035420", name: "NAVER", sector: "Platform", price: 237000 }, 
            { code: "035720", name: "ì¹´ì¹´ì˜¤", sector: "Platform", price: 58700 },
            { code: "006400", name: "ì‚¼ì„±SDI", sector: "Battery", price: 283,500 }, 
            { code: "011070", name: "LGì´ë…¸í…", sector: "IT", price: 278000 },
            { code: "005380", name: "í˜„ëŒ€ì°¨", sector: "Auto", price: 288500 }, 
            { code: "000270", name: "ê¸°ì•„", sector: "Auto", price: 120700 },
            { code: "373220", name: "LGì—ë„ˆì§€ì†”ë£¨ì…˜", sector: "Battery", price: 389500 }, 
            { code: "003670", name: "í¬ìŠ¤ì½”í“¨ì²˜ì— ", sector: "Battery", price: 196200 },
            { code: "012450", name: "í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤", sector: "Defense", price: 897000 }, 
            { code: "079550", name: "LIGë„¥ìŠ¤ì›", sector: "Defense", price: 416500 },
            { code: "042660", name: "í•œí™”ì˜¤ì…˜", sector: "Ship", price: 110700 }, 
            { code: "329180", name: "HDí˜„ëŒ€ì¤‘ê³µì—…", sector: "Ship", price: 516000 },
            { code: "010140", name: "ì‚¼ì„±ì¤‘ê³µì—…", sector: "Ship", price: 24950 }, 
            { code: "066570", name: "HDí˜„ëŒ€ë¯¸í¬", sector: "Ship", price: 223000 },
            { code: "005490", name: "POSCOí™€ë”©ìŠ¤", sector: "Steel", price: 306000 }, 
            { code: "004020", name: "í˜„ëŒ€ì œì² ", sector: "Steel", price: 30600 },
            { code: "004600", name: "ê³ ë ¤ì•„ì—°", sector: "Steel", price: 1384000 }, 
            { code: "051910", name: "LGí™”í•™", sector: "Chem", price: 348000 },
            { code: "096770", name: "SKì´ë…¸ë² ì´ì…˜", sector: "Chem", price: 106000 }, 
            { code: "011170", name: "ë¡¯ë°ì¼€ë¯¸ì¹¼", sector: "Chem", price: 73800 },
            { code: "009830", name: "í•œí™”ì†”ë£¨ì…˜", sector: "Chem", price: 27400 }, 
            { code: "105560", name: "KBê¸ˆìœµ", sector: "Finance", price: 125900 },
            { code: "055550", name: "ì‹ í•œì§€ì£¼", sector: "Finance", price: 78300 }, 
            { code: "000810", name: "ì‚¼ì„±í™”ì¬", sector: "Finance", price: 493500 },
            { code: "323410", name: "ì¹´ì¹´ì˜¤ë±…í¬", sector: "Finance", price: 21900 }, 
            { code: "207940", name: "ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤", sector: "Bio", price: 1731000 },
            { code: "068270", name: "ì…€íŠ¸ë¦¬ì˜¨", sector: "Bio", price: 183700 }, 
            { code: "000100", name: "ìœ í•œì–‘í–‰", sector: "Bio", price: 115800 },
            { code: "004170", name: "ì‹ ì„¸ê³„", sector: "Retail", price: 248000 }, 
            { code: "023530", name: "ë¡¯ë°ì‡¼í•‘", sector: "Retail", price: 74200 },
            { code: "097950", name: "CJì œì¼ì œë‹¹", sector: "Food", price: 210000 }, 
            { code: "352820", name: "HYBE", sector: "Enter", price: 310000 },
            { code: "035900", name: "JYP Ent.", sector: "Enter", price: 70200 }, 
            { code: "041510", name: "ì—ìŠ¤ì— ", sector: "Enter", price: 117500 },
            { code: "122870", name: "YG PLUS", sector: "Enter", price: 6720 }
        ];



        // ê¸°ì—…ë³„ ë§ì¶¤ ì„¤ëª… ë°ì´í„°
        const COMPANY_DESCRIPTIONS = {
            "005930": "ê¸€ë¡œë²Œ ë©”ëª¨ë¦¬ ë°˜ë„ì²´ 1ìœ„ ë° ìŠ¤ë§ˆíŠ¸í°, ê°€ì „ ì„¸ê³„ì  ê¸°ì—…",
            "000660": "ê¸€ë¡œë²Œ ë©”ëª¨ë¦¬ ë°˜ë„ì²´ 2ìœ„, HBM ì‹œì¥ ì„ ë„ ê¸°ì—…",
            "035420": "êµ­ë‚´ 1ìœ„ ê²€ìƒ‰ í¬í„¸ ë° AI, ì»¤ë¨¸ìŠ¤ í”Œë«í¼ ê¸°ì—…",
            "035720": "êµ­ë¯¼ ë©”ì‹ ì € ì¹´ì¹´ì˜¤í†¡ ê¸°ë°˜ì˜ ëª¨ë°”ì¼ ë¼ì´í”„ í”Œë«í¼",
            "006400": "ì†Œí˜• ë°°í„°ë¦¬ ë° ì „ê¸°ì°¨ìš© ì¤‘ëŒ€í˜• ë°°í„°ë¦¬ ì œì¡° ê¸°ì—…",
            "011070": "ëª¨ë°”ì¼ìš© ì¹´ë©”ë¼ ëª¨ë“ˆ ë° ì²¨ë‹¨ ì „ì ë¶€í’ˆ ì œì¡°ì‚¬",
            "005380": "ê¸€ë¡œë²Œ TOP3 ìë™ì°¨ ì™„ì„±ì°¨ ì œì¡°ì—…ì²´",
            "000270": "ë””ìì¸ ê²½ì˜ì„ í†µí•œ ê¸€ë¡œë²Œ ìë™ì°¨ ì œì¡°ì—…ì²´",
            "373220": "ì„¸ê³„ ìµœê³ ì˜ ê¸°ìˆ ë ¥ì„ ë³´ìœ í•œ ì „ê¸°ì°¨ ë°°í„°ë¦¬ ìƒì‚° ê¸°ì—…",
            "003670": "2ì°¨ì „ì§€ ì–‘ê·¹ì¬ ë° ìŒê·¹ì¬ ìƒì‚° ê¸€ë¡œë²Œ ì†Œì¬ ê¸°ì—…",
            "012450": "í•­ê³µìš°ì£¼ ë° ë°©ìœ„ì‚°ì—… ë¶„ì•¼ì˜ ëŒ€í•œë¯¼êµ­ ëŒ€í‘œ ê¸°ì—…",
            "079550": "ì •ë°€ ìœ ë„ë¬´ê¸° ë“± ì²¨ë‹¨ ë¬´ê¸° ì²´ê³„ ê°œë°œ ë°©ì‚°ì—…ì²´",
            "042660": "ì ìˆ˜í•¨ ë° íŠ¹ìˆ˜ì„  ë¶„ì•¼ ê²½ìŸë ¥ì„ ê°–ì¶˜ ì¡°ì„  í•´ì–‘ ê¸°ì—…",
            "329180": "ì„¸ê³„ 1ìœ„ ì¡°ì„  ê¸°ìˆ ë ¥ì„ ë³´ìœ í•œ ì¤‘ê³µì—… íšŒì‚¬",
            "010140": "ê³ ë¶€ê°€ê°€ì¹˜ ì„ ë°• ë° í•´ì–‘ ì„¤ë¹„ ì „ë¬¸ ì¡°ì„  ê¸°ì—…",
            "066570": "ì¤‘í˜• ì„ ë°• ë° PCì„  ë¶„ì•¼ ì„¸ê³„ ì‹œì¥ ì ìœ ìœ¨ 1ìœ„",
            "005490": "ì² ê°•ì„ ë„˜ì–´ 2ì°¨ì „ì§€ ì†Œì¬ë¡œ ë„ì•½í•˜ëŠ” ì¹œí™˜ê²½ ë¯¸ë˜ ì†Œì¬ ê¸°ì—…",
            "004020": "ìë™ì°¨ìš© ê°•íŒ ë° ê±´ì„¤ìš© ì² ê°•ì¬ ìƒì‚° ì „ê¸°ë¡œ ì œì² ì†Œ",
            "004600": "ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ ë¹„ì² ê¸ˆì†(ì•„ì—°, ë‚©) ì œë ¨ ê¸°ì—…",
            "051910": "ì„ìœ í™”í•™, ì²¨ë‹¨ì†Œì¬, ìƒëª…ê³¼í•™ ë¶„ì•¼ì˜ ê¸€ë¡œë²Œ í™”í•™ ê¸°ì—…",
            "096770": "ì •ìœ , í™”í•™, ìœ¤í™œìœ  ë° ë°°í„°ë¦¬ ì‚¬ì—…ì„ ì˜ìœ„í•˜ëŠ” ì—ë„ˆì§€ ê¸°ì—…",
            "011170": "ë‹¤ì–‘í•œ í™”í•™ ì œí’ˆì„ ìƒì‚°í•˜ëŠ” ë¡¯ë°ê·¸ë£¹ì˜ í™”í•™ ê³„ì—´ì‚¬",
            "009830": "íƒœì–‘ê´‘ ì—ë„ˆì§€ ë° ì¼€ë¯¸ì¹¼ ì†Œì¬ ì „ë¬¸ ê¸°ì—…",
            "105560": "ì€í–‰, ì¦ê¶Œ, ë³´í—˜ ë“±ì„ ì•„ìš°ë¥´ëŠ” êµ­ë‚´ ìµœëŒ€ ê¸ˆìœµì§€ì£¼",
            "055550": "ë””ì§€í„¸ í˜ì‹ ì„ ì„ ë„í•˜ëŠ” ê¸€ë¡œë²Œ ê¸ˆìœµ ê·¸ë£¹",
            "000810": "êµ­ë‚´ ì†í•´ë³´í—˜ ì—…ê³„ë¥¼ ì„ ë„í•˜ëŠ” ì‚¼ì„±ì˜ ê¸ˆìœµ ê³„ì—´ì‚¬",
            "323410": "ëª¨ë°”ì¼ ì¤‘ì‹¬ì˜ í˜ì‹ ì ì¸ ì¸í„°ë„· ì „ë¬¸ ì€í–‰",
            "207940": "ê¸€ë¡œë²Œ 1ìœ„ ë°”ì´ì˜¤ ì˜ì•½í’ˆ ìœ„íƒ ìƒì‚°(CMO) ê¸°ì—…",
            "068270": "ë°”ì´ì˜¤ ì‹œë°€ëŸ¬ ë° ì‹ ì•½ ê°œë°œ ê¸€ë¡œë²Œ ë°”ì´ì˜¤ ê¸°ì—…",
            "000100": "ì‹ ì•½ ê°œë°œ(ë ‰ë¼ì ë“±) ì„±ê³¼ë¥¼ ë‚´ëŠ” ì¡´ê²½ë°›ëŠ” ì œì•½ì‚¬",
            "004170": "ë°±í™”ì  ë° íŒ¨ì…˜, ë·°í‹° ì‚¬ì—…ì„ ì˜ìœ„í•˜ëŠ” ìœ í†µ ê³µë£¡",
            "023530": "ë°±í™”ì , ë§ˆíŠ¸, ìŠˆí¼ ë“±ì„ ìš´ì˜í•˜ëŠ” ì¢…í•© ìœ í†µ ê¸°ì—…",
            "097950": "ë¹„ë¹„ê³  ë“± K-í‘¸ë“œ ê¸€ë¡œë²Œ í™•ì‚°ì˜ ì£¼ì—­ì¸ ì‹í’ˆ ê¸°ì—…",
            "352820": "BTS ë“± ê¸€ë¡œë²Œ ì•„í‹°ìŠ¤íŠ¸ë¥¼ ë³´ìœ í•œ ì—”í„°í…Œì¸ë¨¼íŠ¸ í”Œë«í¼",
            "035900": "íŠ¸ì™€ì´ìŠ¤, ìŠ¤íŠ¸ë ˆì´í‚¤ì¦ˆ ë“± K-POP ì•„ì´ëŒ ëª…ê°€",
            "041510": "NCT, ì—ìŠ¤íŒŒ ë“± ë…ì°½ì  IPë¥¼ ë³´ìœ í•œ K-POP ì„ ë‘ì£¼ì",
            "122870": "ìŒì› ìœ í†µ ë° MD ì‚¬ì—… ë“±ì„ ì˜ìœ„í•˜ëŠ” YG ê³„ì—´ì‚¬"
        };

        // [ë‰´ìŠ¤ í™•ì¥] ì¹´í…Œê³ ë¦¬ ì„¸ë¶„í™” ë° ë‰´ìŠ¤ ì¢…ë¥˜ ëŒ€í­ ì¶”ê°€
        const NEWS_TEMPLATES = {
            'Market': [
                { text: "ë¯¸êµ­ ì—°ì¤€, ê¸ˆë¦¬ ë™ê²° ë°œí‘œì— ë‚˜ìŠ¤ë‹¥ ê¸‰ë“±... í›ˆí’ ê¸°ëŒ€", type: "good", impact: 0.03 },
                { text: "ê¸€ë¡œë²Œ ê²½ê¸° ì¹¨ì²´ ìš°ë ¤ í™•ì‚°, ì•ˆì „ ìì‚° ì„ í˜¸ ì‹¬ë¦¬", type: "bad", impact: -0.03 },
                { text: "ì •ë¶€, ëŒ€ê·œëª¨ ì¦ì‹œ ë¶€ì–‘ì±… 'ë°¸ë¥˜ì—… í”„ë¡œê·¸ë¨' ë°œí‘œ", type: "good", impact: 0.02 },
                { text: "ì›/ë‹¬ëŸ¬ í™˜ìœ¨ 1400ì› ëŒíŒŒ... ì™¸êµ­ì¸ ìê¸ˆ ì´íƒˆ ê°€ì†í™”", type: "bad", impact: -0.02 },
                { text: "êµ­ë¯¼ì—°ê¸ˆ, êµ­ë‚´ ì£¼ì‹ ë¹„ì¤‘ í™•ëŒ€ ê²€í†  ì†Œì‹", type: "good", impact: 0.02 }
            ],
            'IT': [
                { text: "{name}, ì°¨ì„¸ëŒ€ AI ë°˜ë„ì²´ ê°œë°œ ì„±ê³µ... ì—…ê³„ ì¶©ê²©", type: "good", impact: 0.07 },
                { text: "{name}, Dë¨ ìˆ˜ìš” ë‘”í™”ë¡œ ì‹¤ì  ë¶€ì§„ ì „ë§", type: "bad", impact: -0.05 },
                { text: "{name}, ê²½ìŸì‚¬ì™€ì˜ íŠ¹í—ˆ ì†Œì†¡ ìŠ¹ì†Œ... ë¶ˆí™•ì‹¤ì„± í•´ì†Œ", type: "good", impact: 0.04 },
                { text: "{name}, ì‹ ê·œ íŒŒìš´ë“œë¦¬ ê³µì¥ ê°€ë™ ì—°ê¸° ì†Œì‹", type: "bad", impact: -0.03 },
                { text: "{name}, AI ë°ì´í„°ì„¼í„° ìˆ˜ì£¼ ëŒ€ë°•... ì–´ë‹ ì„œí”„ë¼ì´ì¦ˆ ê¸°ëŒ€", type: "good", impact: 0.06 }
            ],
            'Platform': [
                { text: "{name}, ì‹ ê·œ AI ì„œë¹„ìŠ¤ ì¶œì‹œ... ì´ìš©ì í­ì¦", type: "good", impact: 0.06 },
                { text: "{name}, í”Œë«í¼ ê·œì œ ë²•ì•ˆ ë°œì˜ ì†Œì‹ì— íˆ¬ì ì‹¬ë¦¬ ìœ„ì¶•", type: "bad", impact: -0.05 },
                { text: "{name}, ì›¹íˆ° ì‚¬ì—…ë¶€ë¬¸ ë‚˜ìŠ¤ë‹¥ ìƒì¥ ì¶”ì§„ì„¤", type: "good", impact: 0.05 },
                { text: "{name}, ì„œë²„ ì¥ì•  ë°œìƒìœ¼ë¡œ ì„œë¹„ìŠ¤ ì´ìš© ì°¨ì§ˆ... ë¹„ë‚œ ì‡„ë„", type: "bad", impact: -0.04 }
            ],
            'Auto': [
                { text: "{name}, ë¶ë¯¸ ì „ê¸°ì°¨ íŒë§¤ëŸ‰ ì—­ëŒ€ ìµœê³ ì¹˜ ê²½ì‹ ", type: "good", impact: 0.06 },
                { text: "{name}, ì°¨ëŸ‰ìš© ë°˜ë„ì²´ ìˆ˜ê¸‰ ë‚œí•­ìœ¼ë¡œ ê³µì¥ ê°€ë™ ì¼ì‹œ ì¤‘ë‹¨", type: "bad", impact: -0.05 },
                { text: "{name}, ë…¸ì¡° íŒŒì—… ë¦¬ìŠ¤í¬ ê³ ì¡°... ìƒì‚° ì°¨ì§ˆ ìš°ë ¤", type: "bad", impact: -0.03 },
                { text: "{name}, ììœ¨ì£¼í–‰ ë ˆë²¨3 ê¸°ìˆ  ìƒìš©í™” ì„ë°• ë°œí‘œ", type: "good", impact: 0.05 }
            ],
            'Battery': [
                { text: "{name}, ìœ ëŸ½ ì™„ì„±ì°¨ ì—…ì²´ì™€ ëŒ€ê·œëª¨ ë°°í„°ë¦¬ ê³µê¸‰ ê³„ì•½ ì²´ê²°", type: "good", impact: 0.07 },
                { text: "{name}, ë¦¬íŠ¬ ë“± ì›ìì¬ ê°€ê²© ê¸‰ë“±ì— ìˆ˜ìµì„± ì•…í™” ìš°ë ¤", type: "bad", impact: -0.04 },
                { text: "{name}, ì „ê³ ì²´ ë°°í„°ë¦¬ ê¸°ìˆ  ê°œë°œ ë¡œë“œë§µ ì•ë‹¹ê²¨", type: "good", impact: 0.06 },
                { text: "{name}, ì „ê¸°ì°¨ ìˆ˜ìš” ë‘”í™”(ìºì¦˜) ê³µí¬ì— íˆ¬ì ì‹¬ë¦¬ ëƒ‰ê°", type: "bad", impact: -0.05 }
            ],
            'Defense': [
                { text: "{name}, í´ë€ë“œì™€ ëŒ€ê·œëª¨ 2ì°¨ ìˆ˜ì¶œ ê³„ì•½ ì²´ê²° ì„ë°•", type: "good", impact: 0.08 },
                { text: "{name}, ì°¨ì„¸ëŒ€ ì „íˆ¬ê¸° ê°œë°œ ì‚¬ì—… ìš°ì„ í˜‘ìƒëŒ€ìƒì ì„ ì •", type: "good", impact: 0.05 },
                { text: "{name}, ì§€ì •í•™ì  ë¦¬ìŠ¤í¬ ì™„í™”ë¡œ ë°©ì‚°ì£¼ ì°¨ìµ ì‹¤í˜„ ë§¤ë¬¼ ì¶œíšŒ", type: "bad", impact: -0.04 }
            ],
            'Ship': [
                { text: "{name}, ì¹´íƒ€ë¥´ LNGì„  ëŒ€ê·œëª¨ ìˆ˜ì£¼ ì­íŒŸ í„°ì¡Œë‹¤", type: "good", impact: 0.07 },
                { text: "{name}, í›„íŒ ê°€ê²© í˜‘ìƒ ë‚œí•­... ì›ê°€ ë¶€ë‹´ ê°€ì¤‘", type: "bad", impact: -0.03 },
                { text: "{name}, ì¹œí™˜ê²½ ì„ ë°• ê¸°ìˆ  ì„¸ê³„ 1ìœ„ ì…ì¦", type: "good", impact: 0.04 },
                { text: "{name}, ì¡°ì„ ì†Œ ì¸ë ¥ë‚œ ì‹¬í™”ë¡œ ë‚©ê¸° ì§€ì—° ìš°ë ¤", type: "bad", impact: -0.04 }
            ],
            'Steel': [
                { text: "{name}, ì¤‘êµ­ ê²½ê¸° ë¶€ì–‘ì±… ê¸°ëŒ€ê°ì— ì² ê°• ìˆ˜ìš” íšŒë³µ ì „ë§", type: "good", impact: 0.04 },
                { text: "{name}, ì›ìì¬ ê°€ê²© ìƒìŠ¹ë¶„ì„ ì œí’ˆê°€ì— ë°˜ì˜ ì„±ê³µ", type: "good", impact: 0.03 },
                { text: "{name}, ê¸€ë¡œë²Œ ê±´ì„¤ ê²½ê¸° ì¹¨ì²´ë¡œ ì‹¤ì  í•˜í–¥ ì¡°ì •", type: "bad", impact: -0.03 }
            ],
            'Chem': [
                { text: "{name}, ìœ ê°€ ìƒìŠ¹ì— ë”°ë¥¸ ì •ì œë§ˆì§„ ê°œì„  ê¸°ëŒ€", type: "good", impact: 0.04 },
                { text: "{name}, ì¤‘êµ­ë°œ ì„ìœ í™”í•™ ì œí’ˆ ê³µê¸‰ ê³¼ì‰ ìš°ë ¤ ì§€ì†", type: "bad", impact: -0.03 },
                { text: "{name}, ì¹œí™˜ê²½ ì†Œì¬ ì‚¬ì—… ì§„ì¶œ ì„ ì–¸... ì‹ ì„±ì¥ ë™ë ¥ í™•ë³´", type: "good", impact: 0.05 }
            ],
            'Finance': [
                { text: "{name}, ì—­ëŒ€ê¸‰ ì‹¤ì  ë‹¬ì„±... ì£¼ì£¼ í™˜ì› ì •ì±… ê°•í™” ë°œí‘œ", type: "good", impact: 0.05 },
                { text: "{name}, ë¶€ë™ì‚° PF ë¶€ì‹¤ ìš°ë ¤ì— ì¶©ë‹¹ê¸ˆ ì ë¦½ ë¶€ë‹´", type: "bad", impact: -0.04 },
                { text: "{name}, ê¸ˆë¦¬ ì¸ìƒ ìˆ˜í˜œì£¼ë¡œ ë¶€ê°ë˜ë©° ì™¸êµ­ì¸ ë§¤ìˆ˜ì„¸", type: "good", impact: 0.03 }
            ],
            'Bio': [
                { text: "{name}, ê°œë°œ ì¤‘ì¸ ì‹ ì•½ ì„ìƒ 3ìƒ ì„±ê³µì  ê²°ê³¼ ë„ì¶œ", type: "good", impact: 0.10 },
                { text: "{name}, FDA ìŠ¹ì¸ ë³´ë¥˜ ì†Œì‹ì— ì£¼ê°€ ê¸‰ë½", type: "bad", impact: -0.08 },
                { text: "{name}, ëŒ€ê·œëª¨ ê¸°ìˆ  ìˆ˜ì¶œ(LO) ê³„ì•½ ì²´ê²° ì†Œì‹", type: "good", impact: 0.09 },
                { text: "{name}, íšŒê³„ ê°ë¦¬ ì´ìŠˆ ë¶ˆê±°ì§€ë©° íˆ¬ì ì‹¬ë¦¬ ì•…í™”", type: "bad", impact: -0.06 }
            ],
            'Retail': [
                { text: "{name}, ì¤‘êµ­ì¸ ë‹¨ì²´ ê´€ê´‘ê°(ìœ ì»¤) ê·€í™˜ì— ë§¤ì¶œ ê¸‰ì¦ ê¸°ëŒ€", type: "good", impact: 0.05 },
                { text: "{name}, ê³ ë¬¼ê°€ì— ë”°ë¥¸ ì†Œë¹„ ì‹¬ë¦¬ ìœ„ì¶•ìœ¼ë¡œ ì‹¤ì  ë¶€ì§„", type: "bad", impact: -0.03 }
            ],
            'Food': [
                { text: "{name}, K-í‘¸ë“œ ì—´í’ íƒ€ê³  í•´ì™¸ ë§¤ì¶œ ì‚¬ìƒ ìµœëŒ€", type: "good", impact: 0.05 },
                { text: "{name}, ê³¡ë¬¼ ê°€ê²© ìƒìŠ¹ìœ¼ë¡œ ì›ê°€ ë¶€ë‹´ ê°€ì¤‘", type: "bad", impact: -0.02 }
            ],
            'Enter': [
                { text: "{name}, ì†Œì† ì•„í‹°ìŠ¤íŠ¸ ì»´ë°± ì•¨ë²” ì„ ì£¼ë¬¸ëŸ‰ ì‹ ê¸°ë¡ ë‹¬ì„±", type: "good", impact: 0.08 },
                { text: "{name}, í•µì‹¬ ë©¤ë²„ ì¬ê³„ì•½ ë¶ˆë°œì„¤... ì£¼ê°€ í”ë“¤", type: "bad", impact: -0.07 },
                { text: "{name}, ì‹ ì¸ ê·¸ë£¹ ë°ë·” ì„±ê³µì ... ì°¨ì„¸ëŒ€ IP í™•ë³´", type: "good", impact: 0.06 },
                { text: "{name}, ì†Œì† ì—°ì˜ˆì¸ ì‚¬ìƒí™œ ë…¼ë€ ë°œìƒ... ì•…ì¬ ëŒì¶œ", type: "bad", impact: -0.05 }
            ],
            'Default': [
                { text: "{name}, ì˜ˆìƒì¹˜ë¥¼ ìƒíšŒí•˜ëŠ” ê¹œì§ ì‹¤ì (ì–´ë‹ ì„œí”„ë¼ì´ì¦ˆ) ë°œí‘œ", type: "good", impact: 0.05 },
                { text: "{name}, ê²½ê¸° ì¹¨ì²´ ìš°ë ¤ì— ëª©í‘œ ì£¼ê°€ ì¤„í•˜í–¥", type: "bad", impact: -0.03 },
                { text: "{name}, ì£¼ì£¼ê°€ì¹˜ ì œê³ ë¥¼ ìœ„í•œ ìì‚¬ì£¼ ë§¤ì… ê²°ì •", type: "good", impact: 0.04 }
            ]
        };

        let currentUser = null;
        let marketData = {}; 
        let userPortfolio = { cash: 50000000, holdings: {} };
        let tradeState = { type: 'buy', code: null };
        let gameState = { day: 1, isOpen: false, gameVersion: 0 }; 
        let allUsersCache = [];
        let chartInstance = null;

        window.showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            
            let bgClass = "bg-blue-600";
            if(type === 'success') bgClass = "bg-green-600";
            if(type === 'error') bgClass = "bg-red-600";
            if(type === 'warning') bgClass = "bg-orange-500";

            el.className = `toast-enter transform transition-all duration-300 pointer-events-auto flex items-center p-4 rounded-lg shadow-lg text-white ${bgClass}`;
            
            let icon = "â„¹ï¸";
            if(type === 'success') icon = "âœ…";
            if(type === 'error') icon = "âš ï¸";
            if(type === 'warning') icon = "ğŸ””";

            el.innerHTML = `
                <span class="text-xl mr-3">${icon}</span>
                <span class="font-medium text-sm">${message}</span>
            `;

            container.appendChild(el);

            if(type === 'error' || type === 'warning') playSound('error');

            setTimeout(() => {
                el.classList.remove('toast-enter');
                el.classList.add('toast-exit');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };

        async function login(e) {
            e.preventDefault(); 
            
            if(audioCtx.state === 'suspended') audioCtx.resume();

            const name = document.getElementById('login-name').value.trim();
            const email = document.getElementById('login-email').value.trim().toLowerCase();

            let userRecord = USERS_DB.find(u => u.name === name && u.email === email);
            if (!userRecord) {
                if (email.endsWith('@pess.cnehs.kr') || email.endsWith('@nonsandaegeon.cnehs.kr')) {
                    userRecord = { name: name, email: email };
                } else if (email !== "test@school.kr") {
                    document.getElementById('login-msg').textContent = "í•™êµ ì´ë©”ì¼ì´ ì•„ë‹ˆê±°ë‚˜ ëª…ë‹¨ì— ì—†ìŠµë‹ˆë‹¤.";
                    return;
                }
            }

            let role = (email === ADMIN_EMAIL) ? 'admin' : 'student';

            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                const docId = email.replace(/[^a-zA-Z0-9]/g, '_'); 
                const userRef = doc(db, `artifacts/${appId}/users`, docId);
                const snap = await getDoc(userRef);

                if (!snap.exists()) {
                    await setDoc(userRef, {
                        name: name, email: email, role: role,
                        cash: 50000000, holdings: {}, transactions: [],
                        totalAssets: 50000000, dataVersion: 0, lastUpdate: serverTimestamp()
                    });
                }
                
                currentUser = { uid: docId, name, email, role };
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                setupUI();
                startRealtimeSync();
                subscribeToRankings();
                showToast(`í™˜ì˜í•©ë‹ˆë‹¤, ${name}ë‹˜!`, 'success');
                playSound('buy'); 
            } catch (err) {
                console.error(err);
                document.getElementById('login-msg').textContent = "ë¡œê·¸ì¸ ì˜¤ë¥˜: " + err.message;
            }
        }

        window.logout = () => { auth.signOut(); location.reload(); };

        function startRealtimeSync() {
            const marketRef = doc(db, `artifacts/${appId}/public/market_state`);
            onSnapshot(marketRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    marketData = data.stocks || {};
                    gameState = { day: data.day || 1, isOpen: data.isOpen, gameVersion: data.gameVersion || 1 };
                    await checkAndResetUserData(gameState.gameVersion);
                    updateMarketUI(); 
                } else if (currentUser.role === 'admin') {
                    initMarketData();
                }
            });

            const myRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            onSnapshot(myRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    userPortfolio = { cash: data.cash, holdings: data.holdings || {} };
                    updatePortfolioUI();
                }
            });

            const newsRef = doc(db, `artifacts/${appId}/public/news`);
            onSnapshot(newsRef, (doc) => {
                if (doc.exists()) {
                    updateNewsUI(doc.data().items || []);
                }
            });
        }
        
        function subscribeToRankings() {
            const q = query(collection(db, `artifacts/${appId}/users`));
            onSnapshot(q, (snapshot) => {
                allUsersCache = [];
                snapshot.forEach(doc => {
                    allUsersCache.push(doc.data());
                });
                renderRankings();
            });
        }

        function renderRankings() {
            const listEl = document.getElementById('ranking-list');
            if (Object.keys(marketData).length === 0 || allUsersCache.length === 0) return;

            const rankedUsers = allUsersCache.map(user => {
                let stockVal = 0;
                if (user.holdings) {
                    Object.keys(user.holdings).forEach(code => {
                        const price = marketData[code]?.price || 0;
                        stockVal += user.holdings[code].quantity * price;
                    });
                }
                return {
                    name: user.name,
                    total: (user.cash || 0) + stockVal,
                    role: user.role
                };
            });

            rankedUsers.sort((a, b) => b.total - a.total);

            listEl.innerHTML = '';
            rankedUsers.slice(0, 10).forEach((u, index) => { 
                const rank = index + 1;
                let rankClass = "bg-gray-100 text-gray-600";
                if(rank === 1) rankClass = "gold-rank font-bold";
                else if(rank === 2) rankClass = "silver-rank font-bold";
                else if(rank === 3) rankClass = "bronze-rank font-bold";

                const isMe = (u.name === currentUser.name) ? "border-2 border-indigo-500" : "";
                
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-2 rounded-lg text-sm ${isMe} ${index < 3 ? 'bg-opacity-90' : 'bg-gray-50'}`;
                div.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs ${rankClass}">${rank}</span>
                        <span class="font-medium text-gray-800">${u.name}</span>
                    </div>
                    <span class="font-bold text-gray-600">${Math.round(u.total).toLocaleString()}</span>
                `;
                listEl.appendChild(div);
            });
        }

        async function checkAndResetUserData(globalVersion) {
            const userRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const userData = userSnap.data();
                if ((userData.dataVersion || 0) < globalVersion) {
                    await setDoc(userRef, {
                        name: currentUser.name, email: currentUser.email, role: currentUser.role,
                        cash: 50000000, holdings: {}, transactions: [],
                        totalAssets: 50000000, dataVersion: globalVersion, lastUpdate: serverTimestamp()
                    });
                    showToast("ìƒˆ ê²Œì„ ì‹œì‘! ìì‚°ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", 'warning');
                }
            }
        }

        window.adminFunc = async (action) => {
            if (currentUser.role !== 'admin') { showToast("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.", 'error'); return; }
            const marketRef = doc(db, `artifacts/${appId}/public/market_state`);
            
            if (action === 'start') {
                await updateDoc(marketRef, { isOpen: true });
                startAutoSimulation(); 
                showToast("ì‹œì¥ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!", 'success');
            } else if (action === 'stop' || action === 'close') {
                await updateDoc(marketRef, { isOpen: false });
                if (simInterval) clearInterval(simInterval);
                showToast("ì¥ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.", 'info');
            } else if (action === 'reset') {
                if(confirm("ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await resetGameGlobal();
            }
        };

        async function resetGameGlobal() {
            const initialData = {};
            INITIAL_STOCKS.forEach(s => {
                initialData[s.code] = {
                    name: s.name, price: s.price, basePrice: s.price,
                    change: 0, rate: 0, sector: s.sector,
                    history: [s.price]
                };
            });
            await setDoc(doc(db, `artifacts/${appId}/public/market_state`), {
                day: 1, isOpen: false, stocks: initialData, gameVersion: increment(1) 
            }, { merge: true });
            setDoc(doc(db, `artifacts/${appId}/public/news`), { items: [] });
            showToast("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ.", 'warning');
        }

        async function initMarketData() {
            const initialData = {};
            INITIAL_STOCKS.forEach(s => {
                initialData[s.code] = {
                    name: s.name, price: s.price, basePrice: s.price,
                    change: 0, rate: 0, sector: s.sector,
                    history: [s.price]
                };
            });
            await setDoc(doc(db, `artifacts/${appId}/public/market_state`), {
                day: 1, isOpen: false, stocks: initialData, gameVersion: 1 
            }, { merge: true });
        }

        let simInterval;
        function startAutoSimulation() {
            if (simInterval) clearInterval(simInterval);
            
            simInterval = setInterval(async () => {
                if (!gameState.isOpen) {
                    clearInterval(simInterval);
                    return;
                }

                const updates = {};
                let newsEvents = [];
                
                // [ìˆ˜ì •] ë‰´ìŠ¤ ë°œìƒ í™•ë¥  ìƒí–¥ (5% -> 15%)
                const triggerNews = Math.random() < 0.15; 
                let affectedStocks = [];
                let newsImpactVal = 0;
                let newsText = "";
                let newsType = "";

                if (triggerNews) {
                    const scopeRand = Math.random();
                    if (scopeRand < 0.2) { 
                        const templates = NEWS_TEMPLATES['Market'];
                        const tmpl = templates[Math.floor(Math.random() * templates.length)];
                        newsText = tmpl.text; newsType = tmpl.type; newsImpactVal = tmpl.impact;
                        affectedStocks = Object.keys(marketData); 
                    } 
                    else if (scopeRand < 0.6) { // ì„¹í„° ë‰´ìŠ¤ ë¹„ì¤‘ í™•ëŒ€
                        const codes = Object.keys(marketData);
                        const randomStock = marketData[codes[Math.floor(Math.random() * codes.length)]];
                        const sector = randomStock.sector;
                        const templates = NEWS_TEMPLATES[sector] || NEWS_TEMPLATES['Default'];
                        const tmpl = templates[Math.floor(Math.random() * templates.length)];
                        newsText = `[${sector}] ` + tmpl.text.replace("{name}", sector + " ì—…ê³„");
                        newsType = tmpl.type; newsImpactVal = tmpl.impact;
                        affectedStocks = codes.filter(c => marketData[c].sector === sector);
                    } 
                    else { 
                        const codes = Object.keys(marketData);
                        const targetCode = codes[Math.floor(Math.random() * codes.length)];
                        const targetStock = marketData[targetCode];
                        const templates = NEWS_TEMPLATES[targetStock.sector] || NEWS_TEMPLATES['Default'];
                        const tmpl = templates[Math.floor(Math.random() * templates.length)];
                        newsText = tmpl.text.replace("{name}", targetStock.name);
                        newsType = tmpl.type; newsImpactVal = tmpl.impact;
                        affectedStocks = [targetCode];
                    }
                }

                Object.keys(marketData).forEach(code => {
                    const stock = marketData[code];
                    let changePct = (Math.random() * 0.01) - 0.005;

                    if (affectedStocks.includes(code)) {
                        const realImpact = newsImpactVal * (0.8 + Math.random() * 0.4);
                        changePct += realImpact;
                    }

                    let newPrice = Math.round(stock.price * (1 + changePct));
                    
                    let history = stock.history || [];
                    history.push(newPrice);
                    if (history.length > 30) history.shift();

                    updates[`stocks.${code}.price`] = newPrice;
                    updates[`stocks.${code}.change`] = newPrice - stock.basePrice;
                    updates[`stocks.${code}.rate`] = ((newPrice - stock.basePrice) / stock.basePrice) * 100;
                    updates[`stocks.${code}.history`] = history;
                });

                const marketRef = doc(db, `artifacts/${appId}/public/market_state`);
                await updateDoc(marketRef, updates);

                if (triggerNews) {
                    const newsRef = doc(db, `artifacts/${appId}/public/news`);
                    const snap = await getDoc(newsRef);
                    let currentNews = snap.exists() ? snap.data().items : [];
                    
                    if (currentNews.length === 0 || currentNews[0].text !== newsText) {
                        const newEvent = {
                            time: new Date().toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'}),
                            text: newsText,
                            type: newsType
                        };
                        const newNewsList = [newEvent, ...currentNews].slice(0, 20); 
                        await updateDoc(newsRef, { items: newNewsList });
                        
                        playSound('news');
                    }
                }
            }, 4000); 
        }

        window.openTradeModal = (code) => {
            if (!gameState.isOpen) {
                showToast("í˜„ì¬ ì¥ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. ê±°ë˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
                return;
            }
            
            const stock = marketData[code];
            tradeState.code = code;
            tradeState.type = 'buy';
            
            document.getElementById('modal-stock-name').innerText = stock.name;
            document.getElementById('modal-stock-code').innerText = code;
            document.getElementById('modal-sector').innerText = stock.sector + " Sector";
            
            // [ìˆ˜ì •] ë§ì¶¤í˜• ì„¤ëª… ë¡œë“œ
            const desc = COMPANY_DESCRIPTIONS[code] || "ëŒ€í•œë¯¼êµ­ ëŒ€í‘œ ìš°ëŸ‰ ê¸°ì—…ì…ë‹ˆë‹¤.";
            document.getElementById('modal-desc').innerText = desc;
            
            document.getElementById('trade-qty').value = 1;

            updateModalUI();
            document.getElementById('trade-modal').classList.remove('hidden');

            renderChart(stock.history || [stock.price], stock.name);
        };

        function renderChart(data, label) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: data.length}, (_, i) => i + 1),
                    datasets: [{
                        label: label + ' ì£¼ê°€',
                        data: data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 0 
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            beginAtZero: false,
                            grid: { display: true, color: '#f3f4f6' }
                        }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        window.setTradeType = (type) => {
            tradeState.type = type;
            const btnBuy = document.getElementById('tab-buy');
            const btnSell = document.getElementById('tab-sell');
            const btnExec = document.getElementById('btn-execute');
            if (type === 'buy') {
                btnBuy.className = "flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-red-600 transition";
                btnSell.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-blue-600 transition";
                btnExec.className = "w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition";
                btnExec.innerText = "ë§¤ìˆ˜ ì£¼ë¬¸";
            } else {
                btnSell.className = "flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-blue-600 transition";
                btnBuy.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-red-600 transition";
                btnExec.className = "w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition";
                btnExec.innerText = "ë§¤ë„ ì£¼ë¬¸";
            }
            updateModalUI();
        };

        window.calcTotal = () => updateModalUI();

        function updateModalUI() {
            const stock = marketData[tradeState.code];
            const price = stock.price;
            const qty = parseInt(document.getElementById('trade-qty').value) || 0;
            
            const rawTotal = price * qty;
            const feeRate = tradeState.type === 'buy' ? FEE_RATES.buy : FEE_RATES.sell;
            const fee = Math.floor(rawTotal * feeRate);
            
            let finalTotal = 0;
            let feeText = "";

            if (tradeState.type === 'buy') {
                finalTotal = rawTotal + fee;
                feeText = `(ìˆ˜ìˆ˜ë£Œ ${fee.toLocaleString()}ì› í¬í•¨)`;
            } else {
                finalTotal = rawTotal - fee;
                feeText = `(ì„¸ê¸ˆ/ìˆ˜ìˆ˜ë£Œ ${fee.toLocaleString()}ì› ì°¨ê°)`;
            }
            
            document.getElementById('modal-price').innerText = price.toLocaleString();
            document.getElementById('trade-total').innerHTML = `
                ${finalTotal.toLocaleString()}ì› <br>
                <span class="text-xs text-gray-400 font-normal">${feeText}</span>
            `;

            const holdings = userPortfolio.holdings || {};
            const myHolding = holdings[tradeState.code] || { quantity: 0 };
            
            if (tradeState.type === 'buy') {
                document.getElementById('available-asset').innerText = "ê°€ìš©: " + userPortfolio.cash.toLocaleString() + "ì›";
            } else {
                document.getElementById('available-asset').innerText = "ë³´ìœ : " + myHolding.quantity + "ì£¼";
            }
        }

        window.setMaxQty = () => {
            const stock = marketData[tradeState.code];
            if (tradeState.type === 'buy') {
                const maxBuyable = Math.floor(userPortfolio.cash / (stock.price * (1 + FEE_RATES.buy)));
                document.getElementById('trade-qty').value = maxBuyable;
            } else {
                const holdings = userPortfolio.holdings || {};
                const holding = holdings[tradeState.code] || { quantity: 0 };
                document.getElementById('trade-qty').value = holding.quantity;
            }
            updateModalUI();
        }

        window.closeModal = () => document.getElementById('trade-modal').classList.add('hidden');

        window.executeOrder = async () => {
            if (!gameState.isOpen) {
                showToast("ì¥ì´ ë§ˆê°ë˜ì–´ ì£¼ë¬¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
                return;
            }
            const qty = parseInt(document.getElementById('trade-qty').value);
            if (qty <= 0) {
                showToast("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.", 'warning');
                return;
            }
            
            const code = tradeState.code;
            const marketRef = doc(db, `artifacts/${appId}/public/market_state`);
            const userRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);

            try {
                await runTransaction(db, async (transaction) => {
                    const marketDoc = await transaction.get(marketRef);
                    const userDoc = await transaction.get(userRef);

                    if (!marketDoc.exists() || !userDoc.exists()) throw "Data Error";

                    const marketState = marketDoc.data();
                    const userData = userDoc.data();
                    
                    if (!marketState.isOpen) throw "Market Closed";

                    const stock = marketState.stocks[code];
                    const currentPrice = stock.price;
                    const rawAmount = currentPrice * qty;
                    let finalAmount = 0;

                    let newHoldings = { ...userData.holdings };
                    let newCash = userData.cash;
                    let stockHolding = newHoldings[code] ? { ...newHoldings[code] } : { quantity: 0, avgPrice: 0 };

                    if (tradeState.type === 'buy') {
                        const fee = Math.floor(rawAmount * FEE_RATES.buy);
                        finalAmount = rawAmount + fee;
                        
                        if (newCash < finalAmount) throw "ì”ì•¡ ë¶€ì¡± (ìˆ˜ìˆ˜ë£Œ í¬í•¨)";
                        newCash -= finalAmount;
                        const newQty = stockHolding.quantity + qty;
                        stockHolding.avgPrice = Math.round(((stockHolding.quantity * stockHolding.avgPrice) + finalAmount) / newQty);
                        stockHolding.quantity = newQty;
                        newHoldings[code] = stockHolding;
                    } else {
                        if (stockHolding.quantity < qty) throw "ì£¼ì‹ ë¶€ì¡±";
                        const fee = Math.floor(rawAmount * FEE_RATES.sell);
                        finalAmount = rawAmount - fee;
                        
                        newCash += finalAmount;
                        stockHolding.quantity -= qty;
                        if (stockHolding.quantity === 0) delete newHoldings[code];
                        else newHoldings[code] = stockHolding;
                    }

                    const direction = tradeState.type === 'buy' ? 1 : -1;
                    const priceImpactPct = (qty / VIRTUAL_MARKET_DEPTH) * direction;
                    let newMarketPrice = Math.round(currentPrice * (1 + priceImpactPct));
                    if (newMarketPrice < 1) newMarketPrice = 1;

                    let history = stock.history || [];
                    history.push(newMarketPrice);
                    if (history.length > 30) history.shift();

                    transaction.update(userRef, { cash: newCash, holdings: newHoldings });
                    
                    const updates = {};
                    updates[`stocks.${code}.price`] = newMarketPrice;
                    updates[`stocks.${code}.change`] = newMarketPrice - stock.basePrice;
                    updates[`stocks.${code}.rate`] = ((newMarketPrice - stock.basePrice) / stock.basePrice) * 100;
                    updates[`stocks.${code}.history`] = history;

                    transaction.update(marketRef, updates);
                });
                
                if(tradeState.type === 'buy') playSound('buy');
                else playSound('sell');

                showToast("ì£¼ë¬¸ì´ ì²´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
                closeModal();
            } catch (e) {
                showToast("ì£¼ë¬¸ ì‹¤íŒ¨: " + e, 'error');
            }
        };

        function setupUI() {
            document.getElementById('user-name-display').innerText = currentUser.name;
            document.getElementById('user-role-display').innerText = currentUser.role === 'admin' ? 'ê´€ë¦¬ì(ì„ ìƒë‹˜)' : 'í•™ìƒ';
            if (currentUser.role === 'admin') document.getElementById('admin-panel').classList.remove('hidden');
        }

        function updateMarketUI() {
            const badge = document.getElementById('market-status-badge');
            if (gameState.isOpen) {
                badge.innerText = "ì‹œì¥ ì§„í–‰ ì¤‘ (09:00 ~ 15:30)";
                badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 animate-pulse";
            } else {
                badge.innerText = "ì¥ ë§ˆê°";
                badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700";
            }
            
            // [ìˆ˜ì •] ë¬¸êµ¬ ì´ˆê¸°í™” (ê³µë€)
            document.getElementById('simulation-time').innerText = "";

            const listEl = document.getElementById('stock-list');
            listEl.innerHTML = ''; 
            
            INITIAL_STOCKS.forEach(initStock => {
                const code = initStock.code;
                const s = marketData[code]; 
                
                if (!s) return; 

                const colorClass = s.rate > 0 ? 'price-up' : (s.rate < 0 ? 'price-down' : 'text-gray-500');
                const sign = s.rate > 0 ? 'â–²' : (s.rate < 0 ? 'â–¼' : '');
                
                const div = document.createElement('div');
                div.className = "grid grid-cols-12 gap-2 px-4 py-3 items-center hover:bg-gray-50 transition border-b border-gray-50";
                div.innerHTML = `
                    <div class="col-span-4 font-medium text-gray-800">${s.name}<span class="block text-xs text-gray-400">${code}</span></div>
                    <div class="col-span-3 text-right font-bold ${colorClass}">${s.price.toLocaleString()}</div>
                    <div class="col-span-3 text-right text-xs ${colorClass}">${sign} ${s.rate.toFixed(2)}%</div>
                    <div class="col-span-2 text-center">
                        <button onclick="openTradeModal('${code}')" class="bg-gray-100 hover:bg-indigo-100 text-indigo-600 px-3 py-1 rounded text-xs font-bold transition">ë¶„ì„/ì£¼ë¬¸</button>
                    </div>
                `;
                listEl.appendChild(div);
            });

            renderRankings();
        }

        function updatePortfolioUI() {
            let stockValuation = 0;
            const holdingsDiv = document.getElementById('portfolio-list');
            holdingsDiv.innerHTML = '';
            const holdings = userPortfolio.holdings || {};

            Object.keys(holdings).forEach(code => {
                const qty = holdings[code].quantity;
                const avg = holdings[code].avgPrice;
                const currentPrice = marketData[code]?.price || 0;
                const value = qty * currentPrice;
                stockValuation += value;

                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-gray-50 rounded-lg";
                div.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800 text-sm">${marketData[code]?.name || code}</p>
                        <p class="text-xs text-gray-500">${qty}ì£¼ (í‰ë‹¨ ${avg.toLocaleString()})</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-800 text-sm">${value.toLocaleString()}ì›</p>
                    </div>
                `;
                holdingsDiv.appendChild(div);
            });

            const total = userPortfolio.cash + stockValuation;
            const profit = total - 50000000;
            const profitRate = (profit / 50000000) * 100;

            document.getElementById('cash-balance').innerText = Math.round(userPortfolio.cash).toLocaleString();
            document.getElementById('total-asset').innerText = Math.round(total).toLocaleString();
            
            const profitEl = document.getElementById('total-profit');
            profitEl.innerText = `${Math.round(profit).toLocaleString()} (${profitRate.toFixed(2)}%)`;
            profitEl.className = profit >= 0 ? "text-lg font-semibold price-up" : "text-lg font-semibold price-down";
        }

        function updateNewsUI(newsList) {
            const ticker = document.getElementById('news-ticker');
            const list = document.getElementById('news-feed-list');
            
            if (newsList.length > 0) {
                const latest = newsList[0];
                const typeIcon = latest.type === 'good' ? 'ğŸ”´ [í˜¸ì¬]' : (latest.type === 'bad' ? 'ğŸ”µ [ì•…ì¬]' : 'âšª [ì „ë§]');
                ticker.innerText = `${latest.time} ${typeIcon} ${latest.text}`;
                
                list.innerHTML = '';
                newsList.slice(0, 10).forEach(news => {
                    const icon = news.type === 'good' ? 'ğŸ”´' : (news.type === 'bad' ? 'ğŸ”µ' : 'âšª');
                    const div = document.createElement('div');
                    div.className = "p-2 border-b border-gray-100 last:border-0";
                    div.innerHTML = `<span class="text-xs text-gray-500">${news.time}</span> <span class="font-bold">${icon}</span> ${news.text}`;
                    list.appendChild(div);
                });
            }
        }

        document.getElementById('login-btn').addEventListener('click', login);
    </script>
</body>
</html>
